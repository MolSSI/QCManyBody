
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://molssi.github.io/QCManyBody/api/">
      
      
        <link rel="prev" href="../how-to-guides/">
      
      
      
      <link rel="icon" href="../logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>API Documentation - QCManyBody Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#qcmanybody.ManyBodyCore" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="QCManyBody Documentation" class="md-header__button md-logo" aria-label="QCManyBody Documentation" data-md-component="logo">
      
  <img src="../logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            QCManyBody Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Documentation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/MolSSI/QCManyBody" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    MolSSI/QCManyBody
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../high-level-interface/" class="md-tabs__link">
        
  
  
    
  
  High-Level Interface

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../core-interface/" class="md-tabs__link">
        
  
  
    
  
  Core Interface

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../qcschema/" class="md-tabs__link">
        
  
  
    
  
  QCSchema

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../how-to-guides/" class="md-tabs__link">
        
  
  
    
  
  How-To Guides

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  API Documentation

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="QCManyBody Documentation" class="md-nav__button md-logo" aria-label="QCManyBody Documentation" data-md-component="logo">
      
  <img src="../logo.png" alt="logo">

    </a>
    QCManyBody Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/MolSSI/QCManyBody" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    MolSSI/QCManyBody
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../high-level-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    High-Level Interface
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../core-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core Interface
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../qcschema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    QCSchema
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../how-to-guides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    How-To Guides
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    API Documentation
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    API Documentation
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#qcmanybody.ManyBodyCore" class="md-nav__link">
    <span class="md-ellipsis">
      ManyBodyCore
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ManyBodyCore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#qcmanybody.ManyBodyCore.format_calc_plan" class="md-nav__link">
    <span class="md-ellipsis">
      format_calc_plan
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.ManyBodyCore.iterate_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      iterate_molecules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.ManyBodyCore.analyze" class="md-nav__link">
    <span class="md-ellipsis">
      analyze
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#qcmanybody.ManyBodyComputer" class="md-nav__link">
    <span class="md-ellipsis">
      ManyBodyComputer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ManyBodyComputer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#qcmanybody.ManyBodyComputer.from_manybodyinput" class="md-nav__link">
    <span class="md-ellipsis">
      from_manybodyinput
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#qcmanybody.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.all_same_shape" class="md-nav__link">
    <span class="md-ellipsis">
      all_same_shape
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.resize_gradient" class="md-nav__link">
    <span class="md-ellipsis">
      resize_gradient
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.resize_hessian" class="md-nav__link">
    <span class="md-ellipsis">
      resize_hessian
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.sum_cluster_data" class="md-nav__link">
    <span class="md-ellipsis">
      sum_cluster_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.labeler" class="md-nav__link">
    <span class="md-ellipsis">
      labeler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.delabeler" class="md-nav__link">
    <span class="md-ellipsis">
      delabeler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.print_nbody_energy" class="md-nav__link">
    <span class="md-ellipsis">
      print_nbody_energy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.collect_vars" class="md-nav__link">
    <span class="md-ellipsis">
      collect_vars
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.provenance_stamp" class="md-nav__link">
    <span class="md-ellipsis">
      provenance_stamp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.translate_qcvariables" class="md-nav__link">
    <span class="md-ellipsis">
      translate_qcvariables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.modelchem_labels" class="md-nav__link">
    <span class="md-ellipsis">
      modelchem_labels
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#qcmanybody.builder" class="md-nav__link">
    <span class="md-ellipsis">
      builder
    </span>
  </a>
  
    <nav class="md-nav" aria-label="builder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#qcmanybody.builder.build_nbody_compute_list" class="md-nav__link">
    <span class="md-ellipsis">
      build_nbody_compute_list
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#qcmanybody.ManyBodyCore" class="md-nav__link">
    <span class="md-ellipsis">
      ManyBodyCore
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ManyBodyCore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#qcmanybody.ManyBodyCore.format_calc_plan" class="md-nav__link">
    <span class="md-ellipsis">
      format_calc_plan
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.ManyBodyCore.iterate_molecules" class="md-nav__link">
    <span class="md-ellipsis">
      iterate_molecules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.ManyBodyCore.analyze" class="md-nav__link">
    <span class="md-ellipsis">
      analyze
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#qcmanybody.ManyBodyComputer" class="md-nav__link">
    <span class="md-ellipsis">
      ManyBodyComputer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ManyBodyComputer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#qcmanybody.ManyBodyComputer.from_manybodyinput" class="md-nav__link">
    <span class="md-ellipsis">
      from_manybodyinput
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#qcmanybody.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.all_same_shape" class="md-nav__link">
    <span class="md-ellipsis">
      all_same_shape
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.resize_gradient" class="md-nav__link">
    <span class="md-ellipsis">
      resize_gradient
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.resize_hessian" class="md-nav__link">
    <span class="md-ellipsis">
      resize_hessian
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.sum_cluster_data" class="md-nav__link">
    <span class="md-ellipsis">
      sum_cluster_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.labeler" class="md-nav__link">
    <span class="md-ellipsis">
      labeler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.delabeler" class="md-nav__link">
    <span class="md-ellipsis">
      delabeler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.print_nbody_energy" class="md-nav__link">
    <span class="md-ellipsis">
      print_nbody_energy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.collect_vars" class="md-nav__link">
    <span class="md-ellipsis">
      collect_vars
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.provenance_stamp" class="md-nav__link">
    <span class="md-ellipsis">
      provenance_stamp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.translate_qcvariables" class="md-nav__link">
    <span class="md-ellipsis">
      translate_qcvariables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qcmanybody.utils.modelchem_labels" class="md-nav__link">
    <span class="md-ellipsis">
      modelchem_labels
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#qcmanybody.builder" class="md-nav__link">
    <span class="md-ellipsis">
      builder
    </span>
  </a>
  
    <nav class="md-nav" aria-label="builder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#qcmanybody.builder.build_nbody_compute_list" class="md-nav__link">
    <span class="md-ellipsis">
      build_nbody_compute_list
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>API Documentation</h1>

<div class="doc doc-object doc-class">



<h2 id="qcmanybody.ManyBodyCore" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">qcmanybody.ManyBodyCore</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ManyBodyCore</span><span class="p">(</span><span class="n">molecule</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="qcelemental.models.Molecule" href="https://molssi.github.io/QCElemental/api/qcelemental.models.Molecule.html#qcelemental.models.Molecule">Molecule</a></span><span class="p">,</span> <span class="n">bsse_type</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Sequence" href="https://docs.python.org/3/library/typing.html#typing.Sequence">Sequence</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="qcmanybody.models.v1.BsseEnum" href="../qcschema/#qcmanybody.models.v1.BsseEnum">BsseEnum</a></span><span class="p">],</span> <span class="n">levels</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Mapping" href="https://docs.python.org/3/library/typing.html#typing.Mapping">Mapping</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Literal" href="https://docs.python.org/3/library/typing.html#typing.Literal">Literal</a></span><span class="p">[</span><span class="s1">&#39;supersystem&#39;</span><span class="p">]],</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">return_total_data</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span><span class="p">,</span> <span class="n">supersystem_ie_only</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span><span class="p">,</span> <span class="n">embedding_charges</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Mapping" href="https://docs.python.org/3/library/typing.html#typing.Mapping">Mapping</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Sequence" href="https://docs.python.org/3/library/typing.html#typing.Sequence">Sequence</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></span><span class="p">]])</span>
</code></pre></div>

    <div class="doc doc-contents first">








                  <details class="quote">
                    <summary>Source code in <code>qcmanybody/core.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">molecule</span><span class="p">:</span> <span class="n">Molecule</span><span class="p">,</span>
    <span class="n">bsse_type</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">BsseEnum</span><span class="p">],</span>
    <span class="n">levels</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;supersystem&quot;</span><span class="p">]],</span> <span class="nb">str</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">return_total_data</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">supersystem_ie_only</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">embedding_charges</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
<span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">embedding_charges</span> <span class="o">=</span> <span class="n">embedding_charges</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_charges</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;QCMANYBODY_EMBEDDING_CHARGES&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>  <span class="c1"># obscure until further validation</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Embedding charges for EE-MBE are still in testing. Set environment variable QCMANYBODY_EMBEDDING_CHARGES=1 to use at your own risk.&quot;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">(</span><span class="o">**</span><span class="n">molecule</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Molecule input type of </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span><span class="si">}</span><span class="s2"> not understood.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">molecule</span> <span class="o">=</span> <span class="n">mol</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bsse_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">BsseEnum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bsse_type</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">return_total_data</span> <span class="o">=</span> <span class="n">return_total_data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">supersystem_ie_only</span> <span class="o">=</span> <span class="n">supersystem_ie_only</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nfragments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecule</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span>

    <span class="c1"># Levels without supersystem</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">levels_no_ss</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">levels</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;supersystem&quot;</span><span class="p">}</span>

    <span class="c1"># Just a set of all the modelchems</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mc_levels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">max_nbody</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels_no_ss</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bsse_type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No BSSE correction specified&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">BsseEnum</span><span class="o">.</span><span class="n">vmfc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsse_type</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># For single-modelchem VMFC, NOCP &amp; sometimes CP are produced for free</span>
        <span class="k">if</span> <span class="n">BsseEnum</span><span class="o">.</span><span class="n">nocp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsse_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bsse_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BsseEnum</span><span class="o">.</span><span class="n">nocp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">BsseEnum</span><span class="o">.</span><span class="n">cp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsse_type</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_nbody</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfragments</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bsse_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BsseEnum</span><span class="o">.</span><span class="n">cp</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">return_bsse_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsse_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1">###############################</span>
    <span class="c1"># Build nbodies_per_mc_level</span>
    <span class="c1"># TODO - use Lori&#39;s code</span>
    <span class="c1"># TODO - dict to list of lists to handle non-contiguous levels</span>
    <span class="c1"># TODO multilevel and supersystem_ie_only=T not allowed together</span>
    <span class="c1"># TODO supersystem in levels is not to be trusted -- nfrag only and skips levels</span>
    <span class="n">max_level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels_no_ss</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels_no_ss</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Levels must be contiguous from 1 to </span><span class="si">{</span><span class="n">max_level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">mc_level</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">mc_level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_levels</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels_no_ss</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="c1"># order nbodies_per_mc_level keys (modelchems) by the lowest n-body level covered; any</span>
    <span class="c1">#   supersystem key (replaced below) is at the end. Order nbodies within each modelchem.</span>
    <span class="c1">#   Reset mc_levels to match.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">1000</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_levels</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="c1"># remove after some downstream testing</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mc_levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">mc</span><span class="p">,</span> <span class="n">nbs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">nbs</span> <span class="ow">and</span> <span class="p">((</span><span class="n">nbs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">nbs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nbs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;QCManyBody: N-Body levels must be contiguous within a model chemistry spec (</span><span class="si">{</span><span class="n">mc</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">nbs</span><span class="si">}</span><span class="s2">). Use an alternate spec name to accomplish this input.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># TODO - test and reenable if appropriate. my guess is that noncontig nb is fine on the core computing side,</span>
            <span class="c1">#   but trouble for computer and nbodies_per_mc_level inverting and indexing. Safer to deflect for now since input tweak allows the calc.</span>

    <span class="c1"># Supersystem is always at the end</span>
    <span class="k">if</span> <span class="s2">&quot;supersystem&quot;</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">:</span>
        <span class="n">ss_mc</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="s2">&quot;supersystem&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span><span class="p">[</span><span class="n">ss_mc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;supersystem&quot;</span><span class="p">)</span>

    <span class="c1"># To be built on the fly</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mc_compute_dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfragments</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Usually we try to &quot;pass-through&quot; edge cases, so a single-fragment mol would return 0 or ordinary energy,</span>
        <span class="c1">#   depending on rtd=T/F. But it seems more likely that user just forgot the fragments field, so we don&#39;t</span>
        <span class="c1">#   want to start a full energy on monsterMol. Reconsider handling in future.</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;QCManyBody: Molecule fragmentation has not been specified through `fragments` field.&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecule</span><span class="o">.</span><span class="n">fragments</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecule</span><span class="o">.</span><span class="n">symbols</span><span class="p">))):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;QCManyBody: non-contiguous fragments could be implemented but aren&#39;t at present&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Build size and slices dictionaries. Assumes fragments are contiguous</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fragment_size_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fragment_slice_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">iat</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ifr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfragments</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">nat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecule</span><span class="o">.</span><span class="n">fragments</span><span class="p">[</span><span class="n">ifr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragment_size_dict</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span> <span class="o">=</span> <span class="n">nat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragment_slice_dict</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">iat</span><span class="p">,</span> <span class="n">iat</span> <span class="o">+</span> <span class="n">nat</span><span class="p">)</span>
        <span class="n">iat</span> <span class="o">+=</span> <span class="n">nat</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="qcmanybody.ManyBodyCore.format_calc_plan" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">format_calc_plan</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">format_calc_plan</span><span class="p">(</span><span class="n">sset</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">]]]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Formulate per-modelchem and per-body job count data and summary text.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sset</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Among {"all", "nocp", "cp", "vmfc_compute"}, which data structure to return.</p>
              </div>
            </td>
            <td>
                  <code>&#39;all&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="info">info</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A text summary with per- model chemistry and per- n-body-level job counts.
<div class="highlight"><pre><span></span><code>Model chemistry &quot;c4-ccsd&quot; (A):         22
     Number of 1-body computations:     16 (nocp: 0, cp: 0, vmfc_compute: 16)
     Number of 2-body computations:      6 (nocp: 0, cp: 0, vmfc_compute: 6)

Model chemistry &quot;c4-mp2&quot; (B):          28
     Number of 1-body computations:     12 (nocp: 0, cp: 0, vmfc_compute: 12)
     Number of 2-body computations:     12 (nocp: 0, cp: 0, vmfc_compute: 12)
     Number of 3-body computations:      4 (nocp: 0, cp: 0, vmfc_compute: 4)
</code></pre></div></p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data structure with outer key mc-label, inner key 1-indexed n-body, and value job count.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">format_calc_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Formulate per-modelchem and per-body job count data and summary text.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sset</span>
<span class="sd">        Among {&quot;all&quot;, &quot;nocp&quot;, &quot;cp&quot;, &quot;vmfc_compute&quot;}, which data structure to return.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    info</span>
<span class="sd">        A text summary with per- model chemistry and per- n-body-level job counts.</span>
<span class="sd">        ```</span>
<span class="sd">        Model chemistry &quot;c4-ccsd&quot; (A):         22</span>
<span class="sd">             Number of 1-body computations:     16 (nocp: 0, cp: 0, vmfc_compute: 16)</span>
<span class="sd">             Number of 2-body computations:      6 (nocp: 0, cp: 0, vmfc_compute: 6)</span>

<span class="sd">        Model chemistry &quot;c4-mp2&quot; (B):          28</span>
<span class="sd">             Number of 1-body computations:     12 (nocp: 0, cp: 0, vmfc_compute: 12)</span>
<span class="sd">             Number of 2-body computations:     12 (nocp: 0, cp: 0, vmfc_compute: 12)</span>
<span class="sd">             Number of 3-body computations:      4 (nocp: 0, cp: 0, vmfc_compute: 4)</span>
<span class="sd">        ```</span>
<span class="sd">    Dict[str, Dict[int, int]]</span>
<span class="sd">        Data structure with outer key mc-label, inner key 1-indexed n-body, and value job count.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Rearrange compute_list from key nb having values (species) to compute all of that nb</span>
    <span class="c1">#   to key nb having values counting that nb.</span>
    <span class="n">compute_list_count</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">mc</span><span class="p">,</span> <span class="n">compute_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">compute_list_count</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">compute_dict</span><span class="p">:</span>  <span class="c1"># all, nocp, cp, vmfc</span>
            <span class="n">all_calcs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">compute_dict</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">compute_list_count</span><span class="p">[</span><span class="n">mc</span><span class="p">][</span><span class="n">sub</span><span class="p">]</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">all_calcs</span><span class="p">])</span>

    <span class="n">mc_labels</span> <span class="o">=</span> <span class="n">modelchem_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span><span class="p">,</span> <span class="n">presorted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">full_to_ordinal_mc_lbl</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mc_labels</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mc</span><span class="p">,</span> <span class="n">counter</span> <span class="ow">in</span> <span class="n">compute_list_count</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">all_counter</span> <span class="o">=</span> <span class="n">counter</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>
        <span class="n">mcheader</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;    Model chemistry &quot;</span><span class="si">{</span><span class="n">mc</span><span class="si">}</span><span class="s1">&quot; (</span><span class="si">{</span><span class="n">full_to_ordinal_mc_lbl</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span><span class="si">}</span><span class="s1">):&#39;</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mcheader</span><span class="si">:</span><span class="s2">38</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">all_counter</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="si">:</span><span class="s2">6</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nb</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_counter</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">other_counts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">counter</span><span class="p">[</span><span class="n">sub</span><span class="p">][</span><span class="n">nb</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nocp&quot;</span><span class="p">,</span> <span class="s2">&quot;cp&quot;</span><span class="p">,</span> <span class="s2">&quot;vmfc_compute&quot;</span><span class="p">]]</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        Number of </span><span class="si">{</span><span class="n">nb</span><span class="si">}</span><span class="s2">-body computations: </span><span class="si">{</span><span class="n">count</span><span class="si">:</span><span class="s2">6</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other_counts</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">info</span><span class="p">,</span> <span class="p">{</span><span class="n">mc</span><span class="p">:</span> <span class="n">dsset</span><span class="p">[</span><span class="n">sset</span><span class="p">]</span> <span class="k">for</span> <span class="n">mc</span><span class="p">,</span> <span class="n">dsset</span> <span class="ow">in</span> <span class="n">compute_list_count</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="qcmanybody.ManyBodyCore.iterate_molecules" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">iterate_molecules</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">iterate_molecules</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Iterable" href="https://docs.python.org/3/library/typing.html#typing.Iterable">Iterable</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="qcelemental.models.Molecule" href="https://molssi.github.io/QCElemental/api/qcelemental.models.Molecule.html#qcelemental.models.Molecule">Molecule</a></span><span class="p">]]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Iterate over all the molecules needed for the computation.</p>
<p>Yields model chemistry, label, and molecule.</p>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">iterate_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iterate over all the molecules needed for the computation.</span>

<span class="sd">    Yields model chemistry, label, and molecule.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">done_molecules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">mc</span><span class="p">,</span> <span class="n">compute_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># TODO - this is a bit of a hack. Lots of duplication when reaching higher nbody</span>
        <span class="k">for</span> <span class="n">compute_list</span> <span class="ow">in</span> <span class="n">compute_dict</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">real_atoms</span><span class="p">,</span> <span class="n">basis_atoms</span> <span class="ow">in</span> <span class="n">compute_list</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">labeler</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="n">real_atoms</span><span class="p">,</span> <span class="n">basis_atoms</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">done_molecules</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">ghost_atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">basis_atoms</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">real_atoms</span><span class="p">))</span>

                <span class="c1"># Shift to zero-indexing</span>
                <span class="n">real_atoms_0</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">real_atoms</span><span class="p">]</span>
                <span class="n">ghost_atoms_0</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ghost_atoms</span><span class="p">]</span>
                <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule</span><span class="o">.</span><span class="n">get_fragment</span><span class="p">(</span><span class="n">real_atoms_0</span><span class="p">,</span> <span class="n">ghost_atoms_0</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">group_fragments</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">updates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fix_com&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;fix_orientation&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule</span><span class="o">.</span><span class="n">fix_symmetry</span> <span class="o">==</span> <span class="s2">&quot;c1&quot;</span><span class="p">:</span>
                    <span class="c1"># symmetry in the parent usually irrelevant to symmetry in the fragments, but</span>
                    <span class="c1">#   if parent symmetry is cancelled, catch that and pass it along</span>
                    <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;fix_symmetry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;c1&quot;</span>
                <span class="n">mol</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="n">updates</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_charges</span><span class="p">:</span>
                    <span class="n">embedding_frags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfragments</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">basis_atoms</span><span class="p">))</span>
                    <span class="n">charges</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">ifr</span> <span class="ow">in</span> <span class="n">embedding_frags</span><span class="p">:</span>
                        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule</span><span class="o">.</span><span class="n">get_fragment</span><span class="p">(</span><span class="n">ifr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">charges</span><span class="o">.</span><span class="n">extend</span><span class="p">([[</span><span class="n">chg</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_charges</span><span class="p">[</span><span class="n">ifr</span><span class="p">])])</span>
                    <span class="n">mol</span><span class="o">.</span><span class="n">extras</span><span class="p">[</span><span class="s2">&quot;embedding_charges&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">charges</span>

                <span class="n">done_molecules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">mc</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mol</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="qcmanybody.ManyBodyCore.analyze" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">analyze</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">analyze</span><span class="p">(</span><span class="n">component_results</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></span><span class="p">]]])</span>
</code></pre></div>

    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>component_results</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nested dictionary with results from all individual molecular system
calculations, including all subsystem/basis combinations, all model
chemistries, and all properties (e.g., e/g/h).</p>
<p>For example, the below is the format for a nocp gradient run on a
helium dimer with 1-body at CCSD and 2-body at MP2. The outer string
key can be generated with the <code>qcmanybody.utils.labeler</code> function.
The inner string key is any property; QCManyBody presently knows how
to process energy/gradient/Hessian.
<div class="highlight"><pre><span></span><code>{&#39;[&quot;ccsd&quot;, [1], [1]]&#39;: {&#39;energy&#39;: -2.87, &#39;gradient&#39;: array([[0., 0., 0.]])},
 &#39;[&quot;ccsd&quot;, [2], [2]]&#39;: {&#39;energy&#39;: -2.87, &#39;gradient&#39;: array([[0., 0., 0.]])},
 &#39;[&quot;mp2&quot;, [1], [1]]&#39;: {&#39;energy&#39;: -2.86, &#39;gradient&#39;: array([[0., 0., 0.]])},
 &#39;[&quot;mp2&quot;, [2], [2]]&#39;: {&#39;energy&#39;: -2.86, &#39;gradient&#39;: array([[0., 0., 0.]])},
 &#39;[&quot;mp2&quot;, [1, 2], [1, 2]]&#39;: {&#39;energy&#39;: -5.73, &#39;gradient&#39;: array([[ 0., 0., 0.0053], [ 0., 0., -0.0053]])},
}
</code></pre></div></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">component_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    component_results</span>
<span class="sd">        Nested dictionary with results from all individual molecular system</span>
<span class="sd">        calculations, including all subsystem/basis combinations, all model</span>
<span class="sd">        chemistries, and all properties (e.g., e/g/h).</span>

<span class="sd">        For example, the below is the format for a nocp gradient run on a</span>
<span class="sd">        helium dimer with 1-body at CCSD and 2-body at MP2. The outer string</span>
<span class="sd">        key can be generated with the ``qcmanybody.utils.labeler`` function.</span>
<span class="sd">        The inner string key is any property; QCManyBody presently knows how</span>
<span class="sd">        to process energy/gradient/Hessian.</span>
<span class="sd">        ```</span>
<span class="sd">        {&#39;[&quot;ccsd&quot;, [1], [1]]&#39;: {&#39;energy&#39;: -2.87, &#39;gradient&#39;: array([[0., 0., 0.]])},</span>
<span class="sd">         &#39;[&quot;ccsd&quot;, [2], [2]]&#39;: {&#39;energy&#39;: -2.87, &#39;gradient&#39;: array([[0., 0., 0.]])},</span>
<span class="sd">         &#39;[&quot;mp2&quot;, [1], [1]]&#39;: {&#39;energy&#39;: -2.86, &#39;gradient&#39;: array([[0., 0., 0.]])},</span>
<span class="sd">         &#39;[&quot;mp2&quot;, [2], [2]]&#39;: {&#39;energy&#39;: -2.86, &#39;gradient&#39;: array([[0., 0., 0.]])},</span>
<span class="sd">         &#39;[&quot;mp2&quot;, [1, 2], [1, 2]]&#39;: {&#39;energy&#39;: -5.73, &#39;gradient&#39;: array([[ 0., 0., 0.0053], [ 0., 0., -0.0053]])},</span>
<span class="sd">        }</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># All properties that were passed to us</span>
    <span class="c1"># * seed with &quot;energy&quot; so free/no-op jobs can process</span>
    <span class="n">available_properties</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;energy&quot;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">property_data</span> <span class="ow">in</span> <span class="n">component_results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">available_properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">property_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># reorganize to component_results_inv[property][label] = 1.23</span>
    <span class="n">component_results_inv</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">available_properties</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">cluster_label</span><span class="p">,</span> <span class="n">property_data</span> <span class="ow">in</span> <span class="n">component_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">property_label</span><span class="p">,</span> <span class="n">property_value</span> <span class="ow">in</span> <span class="n">property_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">component_results_inv</span><span class="p">[</span><span class="n">property_label</span><span class="p">][</span><span class="n">cluster_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">property_value</span>

    <span class="c1"># Remove any missing data</span>
    <span class="n">component_results_inv</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">component_results_inv</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">component_results_inv</span><span class="p">:</span>
        <span class="c1"># Note B: Rarely, &quot;no results&quot; is expected, like for CP-only,</span>
        <span class="c1">#   rtd=False, and max_nbody=1. We&#39;ll add a dummy entry so</span>
        <span class="c1">#   processing can continue.</span>
        <span class="n">component_results_inv</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;[&quot;dummy&quot;, [1000], [1000]]&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>

    <span class="c1"># Actually analyze</span>
    <span class="n">is_embedded</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_charges</span><span class="p">)</span>
    <span class="n">component_properties</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">all_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nbody_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stdout</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="c1">#        all_results[&quot;energy_body_dict&quot;] = {&quot;cp&quot;: {1: 0.0}}</span>

    <span class="k">for</span> <span class="n">property_label</span><span class="p">,</span> <span class="n">property_results</span> <span class="ow">in</span> <span class="n">component_results_inv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Expand gradient and hessian</span>
        <span class="k">if</span> <span class="n">property_label</span> <span class="o">==</span> <span class="s2">&quot;gradient&quot;</span><span class="p">:</span>
            <span class="n">property_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_gradient</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">delabeler</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">property_results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="n">property_label</span> <span class="o">==</span> <span class="s2">&quot;hessian&quot;</span><span class="p">:</span>
            <span class="n">property_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_hessian</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">delabeler</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">property_results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze</span><span class="p">(</span><span class="n">property_label</span><span class="p">,</span> <span class="n">property_results</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">property_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">component_properties</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;calcinfo_natom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecule</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span>
            <span class="n">component_properties</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;return_</span><span class="si">{</span><span class="n">property_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">bt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsse_type</span><span class="p">:</span>
        <span class="n">stdout</span> <span class="o">+=</span> <span class="n">print_nbody_energy</span><span class="p">(</span>
            <span class="n">all_results</span><span class="p">[</span><span class="s2">&quot;energy_body_dict&quot;</span><span class="p">][</span><span class="n">bt</span><span class="p">],</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bt</span><span class="o">.</span><span class="n">formal</span><span class="p">()</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">bt</span><span class="o">.</span><span class="n">abbr</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfragments</span><span class="p">,</span>
            <span class="n">modelchem_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span><span class="p">,</span> <span class="n">presorted</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">is_embedded</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">supersystem_ie_only</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_nbody</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_supersystem</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">property_label</span> <span class="ow">in</span> <span class="n">available_properties</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">bt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsse_type</span><span class="p">:</span>
            <span class="n">nbody_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">collect_vars</span><span class="p">(</span>
                    <span class="n">bt</span><span class="p">,</span>
                    <span class="n">property_label</span><span class="p">,</span>
                    <span class="n">all_results</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">property_label</span><span class="si">}</span><span class="s2">_body_dict&quot;</span><span class="p">][</span><span class="n">bt</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_nbody</span><span class="p">,</span>
                    <span class="n">is_embedded</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">supersystem_ie_only</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">has_supersystem</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="n">all_results</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbody_dict</span>
    <span class="n">all_results</span><span class="p">[</span><span class="s2">&quot;component_properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_properties</span>

    <span class="c1"># Make dictionary with &quot;1cp&quot;, &quot;2cp&quot;, etc</span>
    <span class="n">ebd</span> <span class="o">=</span> <span class="n">all_results</span><span class="p">[</span><span class="s2">&quot;energy_body_dict&quot;</span><span class="p">]</span>
    <span class="n">all_results</span><span class="p">[</span><span class="s2">&quot;energy_body_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">bt</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">bt</span> <span class="ow">in</span> <span class="n">ebd</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ebd</span><span class="p">[</span><span class="n">bt</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">all_results</span><span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stdout</span>

    <span class="k">return</span> <span class="n">all_results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="qcmanybody.ManyBodyComputer" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">qcmanybody.ManyBodyComputer</span>


</h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="qcmanybody.computer.BaseComputerQCNG">BaseComputerQCNG</span></code></p>











  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="qcmanybody.ManyBodyComputer.from_manybodyinput" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">from_manybodyinput</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">from_manybodyinput</span><span class="p">(</span><span class="n">input_model</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="qcmanybody.models.v1.ManyBodyInput" href="../qcschema/#qcmanybody.models.v1.ManyBodyInput">ManyBodyInput</a></span><span class="p">,</span> <span class="n">build_tasks</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>qcmanybody/computer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_manybodyinput</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_model</span><span class="p">:</span> <span class="n">ManyBodyInput</span><span class="p">,</span> <span class="n">build_tasks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>

    <span class="n">computer_model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">molecule</span><span class="o">=</span><span class="n">input_model</span><span class="o">.</span><span class="n">molecule</span><span class="p">,</span>
        <span class="n">driver</span><span class="o">=</span><span class="n">input_model</span><span class="o">.</span><span class="n">specification</span><span class="o">.</span><span class="n">driver</span><span class="p">,</span>
        <span class="c1"># v2: **input_model.specification.keywords.model_dump(exclude_unset=True),</span>
        <span class="o">**</span><span class="n">input_model</span><span class="o">.</span><span class="n">specification</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">input_data</span><span class="o">=</span><span class="n">input_model</span><span class="p">,</span>  <span class="c1"># storage, to reconstitute ManyBodyResult</span>
    <span class="p">)</span>
    <span class="n">nb_per_mc</span> <span class="o">=</span> <span class="n">computer_model</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span>

    <span class="c1"># print(&quot;\n&lt;&lt;&lt;  (ZZ 1) QCEngine harness ManyBodyComputerQCNG.from_qcschema_ben  &gt;&gt;&gt;&quot;)</span>
    <span class="c1"># v2: pprint.pprint(computer_model.model_dump(), width=200)</span>
    <span class="c1"># pprint.pprint(computer_model.dict(), width=200)</span>
    <span class="c1"># print(f&quot;nbodies_per_mc_level={nb_per_mc}&quot;)</span>

    <span class="n">comp_levels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">mc_level_idx</span><span class="p">,</span> <span class="n">mtd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">computer_model</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="k">for</span> <span class="n">lvl1</span> <span class="ow">in</span> <span class="n">nb_per_mc</span><span class="p">[</span><span class="n">mc_level_idx</span><span class="p">]:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;supersystem&quot;</span> <span class="k">if</span> <span class="n">lvl1</span> <span class="o">==</span> <span class="s2">&quot;supersystem&quot;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">lvl1</span><span class="p">)</span>
            <span class="n">comp_levels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtd</span>

    <span class="n">specifications</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">mtd</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">computer_model</span><span class="o">.</span><span class="n">input_data</span><span class="o">.</span><span class="n">specification</span><span class="o">.</span><span class="n">specification</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
        <span class="n">specifications</span><span class="p">[</span><span class="n">mtd</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">specifications</span><span class="p">[</span><span class="n">mtd</span><span class="p">][</span><span class="s2">&quot;program&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;program&quot;</span><span class="p">)</span>
        <span class="n">specifications</span><span class="p">[</span><span class="n">mtd</span><span class="p">][</span><span class="s2">&quot;specification&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="n">specifications</span><span class="p">[</span><span class="n">mtd</span><span class="p">][</span><span class="s2">&quot;specification&quot;</span><span class="p">][</span>
            <span class="s2">&quot;driver&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">computer_model</span><span class="o">.</span><span class="n">driver</span>  <span class="c1"># overrides atomic driver with mb driver</span>
        <span class="n">specifications</span><span class="p">[</span><span class="n">mtd</span><span class="p">][</span><span class="s2">&quot;specification&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;schema_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">computer_model</span><span class="o">.</span><span class="n">qcmb_core</span> <span class="o">=</span> <span class="n">ManyBodyCore</span><span class="p">(</span>
        <span class="n">computer_model</span><span class="o">.</span><span class="n">molecule</span><span class="p">,</span>
        <span class="n">computer_model</span><span class="o">.</span><span class="n">bsse_type</span><span class="p">,</span>
        <span class="n">comp_levels</span><span class="p">,</span>
        <span class="n">return_total_data</span><span class="o">=</span><span class="n">computer_model</span><span class="o">.</span><span class="n">return_total_data</span><span class="p">,</span>
        <span class="n">supersystem_ie_only</span><span class="o">=</span><span class="n">computer_model</span><span class="o">.</span><span class="n">supersystem_ie_only</span><span class="p">,</span>
        <span class="n">embedding_charges</span><span class="o">=</span><span class="n">computer_model</span><span class="o">.</span><span class="n">embedding_charges</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># check that core and computer storage are consistent in mc ordering and grouping and nbody levels</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">computer_model</span><span class="o">.</span><span class="n">qcmb_core</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="n">computer_model</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;CORE </span><span class="si">{</span><span class="n">computer_model</span><span class="o">.</span><span class="n">qcmb_core</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="si">}</span><span class="s2"> != COMPUTER </span><span class="si">{</span><span class="n">computer_model</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">computer_model</span><span class="o">.</span><span class="n">qcmb_core</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">computer_model</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;CORE </span><span class="si">{</span><span class="n">computer_model</span><span class="o">.</span><span class="n">qcmb_core</span><span class="o">.</span><span class="n">nbodies_per_mc_level</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2"> != COMPUTER </span><span class="si">{</span><span class="n">computer_model</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">build_tasks</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">computer_model</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">qcengine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">qcng</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
            <span class="s2">&quot;Python module qcengine not found. Solve by installing it: &quot;</span>
            <span class="s2">&quot;`conda install qcengine -c conda-forge` or `pip install qcengine`&quot;</span>
        <span class="p">)</span>

    <span class="n">component_properties</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">component_results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">chem</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">imol</span> <span class="ow">in</span> <span class="n">computer_model</span><span class="o">.</span><span class="n">qcmb_core</span><span class="o">.</span><span class="n">iterate_molecules</span><span class="p">():</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">AtomicInput</span><span class="p">(</span><span class="n">molecule</span><span class="o">=</span><span class="n">imol</span><span class="p">,</span> <span class="o">**</span><span class="n">specifications</span><span class="p">[</span><span class="n">chem</span><span class="p">][</span><span class="s2">&quot;specification&quot;</span><span class="p">])</span>
        <span class="c1"># inp = AtomicInput(molecule=imol, **specifications[chem][&quot;specification&quot;], extras={&quot;psiapi&quot;: True})  # faster for p4</span>

        <span class="k">if</span> <span class="n">imol</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;embedding_charges&quot;</span><span class="p">):</span>  <span class="c1"># or test on self.embedding_charges ?</span>
            <span class="k">if</span> <span class="n">specifications</span><span class="p">[</span><span class="n">chem</span><span class="p">][</span><span class="s2">&quot;program&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;psi4&quot;</span><span class="p">:</span>
                <span class="n">charges</span> <span class="o">=</span> <span class="n">imol</span><span class="o">.</span><span class="n">extras</span><span class="p">[</span><span class="s2">&quot;embedding_charges&quot;</span><span class="p">]</span>
                <span class="n">fkw</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function_kwargs&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">fkw</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;external_potentials&quot;</span><span class="p">:</span> <span class="n">charges</span><span class="p">})</span>
                <span class="n">inp</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s2">&quot;function_kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fkw</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Don&#39;t know how to handle external charges in </span><span class="si">{</span><span class="n">specifications</span><span class="p">[</span><span class="n">chem</span><span class="p">][</span><span class="s1">&#39;program&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span> <span class="n">bas</span> <span class="o">=</span> <span class="n">delabeler</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">qcng</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">specifications</span><span class="p">[</span><span class="n">chem</span><span class="p">][</span><span class="s2">&quot;program&quot;</span><span class="p">])</span>
        <span class="n">component_results</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="c1"># print(result.error.error_message)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Calculation did not succeed! Error:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">error_message</span><span class="p">)</span>

        <span class="c1"># pull out stuff</span>
        <span class="n">props</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="s2">&quot;gradient&quot;</span><span class="p">,</span> <span class="s2">&quot;hessian&quot;</span><span class="p">}</span>

        <span class="n">component_properties</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;return_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;return_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># print(f&quot;  {label} {p}: {v}&quot;)</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">component_properties</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="c1"># print(&quot;\n&lt;&lt;&lt;  (ZZ 2) QCEngine harness ManyBodyComputerQCNG.from_qcschema_ben component_properties  &gt;&gt;&gt;&quot;)</span>
    <span class="c1"># with np.printoptions(precision=6, suppress=True):</span>
    <span class="c1">#     pprint.pprint(component_properties, width=200)</span>

    <span class="n">analyze_back</span> <span class="o">=</span> <span class="n">computer_model</span><span class="o">.</span><span class="n">qcmb_core</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">component_properties</span><span class="p">)</span>
    <span class="n">analyze_back</span><span class="p">[</span><span class="s2">&quot;nbody_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">component_properties</span><span class="p">)</span>
    <span class="c1"># print(&quot;\n&lt;&lt;&lt;  (ZZ 3) QCEngine harness ManyBodyComputerQCNG.from_qcschema_ben analyze_back  &gt;&gt;&gt;&quot;)</span>
    <span class="c1"># pprint.pprint(analyze_back, width=200)</span>

    <span class="k">return</span> <span class="n">computer_model</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">external_results</span><span class="o">=</span><span class="n">analyze_back</span><span class="p">,</span> <span class="n">component_results</span><span class="o">=</span><span class="n">component_results</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p><strong>ManyBodyComputer</strong></p>
<table>
<thead>
<tr>
<th>key</th>
<th>type</th>
<th>required</th>
<th>description</th>
<th>default</th>
</tr>
</thead>
<tbody>
<tr>
<td>input_data</td>
<td><class 'qcmanybody.models.v1.manybody_input_pydv1.ManyBodyInput'></td>
<td>True</td>
<td>Input schema containing the relevant settings for performing the many body expansion. This is entirely redundant with the piecemeal assembly of this Computer class and is only stored to be available for error handling and exact reconstruction of ManyBodyResult.</td>
<td>None</td>
</tr>
<tr>
<td>bsse_type</td>
<td><enum 'BsseEnum'></td>
<td>False</td>
<td>Requested BSSE treatments. First in list determines which interaction or total energy/gradient/Hessian returned.</td>
<td>[<BsseEnum.cp: 'cp'>]</td>
</tr>
<tr>
<td>molecule</td>
<td><class 'qcelemental.models.molecule.Molecule'></td>
<td>True</td>
<td>Target molecule for many body expansion (MBE) or interaction energy (IE) analysis. Fragmentation should already be defined in <code>fragments</code> and related fields.</td>
<td>None</td>
</tr>
<tr>
<td>driver</td>
<td><enum 'DriverEnum'></td>
<td>True</td>
<td>The computation driver; i.e., energy, gradient, hessian. In case of ambiguity (e.g., MBE gradient through finite difference energies or MBE energy through composite method), this field refers to the <em>target</em> derivative, not any <em>means</em> specification.</td>
<td>None</td>
</tr>
<tr>
<td>embedding_charges</td>
<td>typing.List[float]</td>
<td>False</td>
<td>Atom-centered point charges to be used to speed up nbody-level convergence. Charges are placed on molecule fragments whose basis sets are not included in the computation. (An implication is that charges aren't invoked for bsse_type=cp.) Keys: 1-based index of fragment. Values: list of atom charges for that fragment.</td>
<td>None</td>
</tr>
<tr>
<td>return_total_data</td>
<td><class 'bool'></td>
<td>False</td>
<td>When True, returns the total data (energy/gradient/Hessian) of the system, otherwise returns interaction data. Default is False for energies, True for gradients and Hessians. Note that the calculation of counterpoise corrected total energies implies the calculation of the energies of monomers in the monomer basis, hence specifying <code>return_total_data = True</code> may carry out more computations than <code>return_total_data = False</code>. For gradients and Hessians, <code>return_total_data = False</code> is rarely useful.</td>
<td>None</td>
</tr>
<tr>
<td>levels</td>
<td><class 'str'></td>
<td>False</td>
<td>Dictionary of different levels of theory for different levels of expansion. Note that the primary method_string is not used when this keyword is given. <code>supersystem</code> computes all higher order n-body effects up to the number of fragments; this higher-order correction uses the nocp basis, regardless of bsse_type. A method fills in for any lower unlisted nbody levels. Note that if both this and max_nbody are provided, they must be consistent. Examples: SUPERSYSTEM definition suspect* {1: 'ccsd(t)', 2: 'mp2', 'supersystem': 'scf'} * {2: 'ccsd(t)/cc-pvdz', 3: 'mp2'} * Now invalid: {1: 2, 2: 'ccsd(t)/cc-pvdz', 3: 'mp2'} Examples above are processed in the ManyBodyComputer, and once processed, only the values should be used. The keys turn into nbodies_per_mc_level, as notated below. * {1: 'ccsd(t)', 2: 'mp2', 'supersystem': 'scf'} -&gt; nbodies_per_mc_level=[[1], [2], ['supersystem']] * {2: 'ccsd(t)/cc-pvdz', 3: 'mp2'} -&gt; nbodies_per_mc_level=[[1, 2], [3]]</td>
<td>None</td>
</tr>
<tr>
<td>max_nbody</td>
<td><class 'int'></td>
<td>False</td>
<td>Maximum number of bodies to include in the many-body treatment. Possible: max_nbody &lt;= nfragments. Default: max_nbody = nfragments.</td>
<td>None</td>
</tr>
<tr>
<td>supersystem_ie_only</td>
<td><class 'bool'></td>
<td>False</td>
<td>Target the supersystem total/interaction energy (IE) data over the many-body expansion (MBE) analysis, thereby omitting intermediate-body calculations. When False (default), compute each n-body level in the MBE up through <code>max_nbody</code>. When True (only allowed for <code>max_nbody = nfragments</code> ), only compute enough for the overall interaction/total energy: max_nbody-body and 1-body. When True, properties <code>INTERACTION {driver} THROUGH {max_nbody}-BODY</code> will always be available; <code>TOTAL {driver} THROUGH {max_nbody}-BODY</code> will be available depending on <code>return_total_data</code> ; and <code>{max_nbody}-BODY CONTRIBUTION TO {driver}</code> won't be available (except for dimers). This keyword produces no savings for a two-fragment molecule. But for the interaction energy of a three-fragment molecule, for example, 2-body subsystems can be skipped with <code>supersystem_ie_only=True</code>. Do not use with <code>vmfc</code> in <code>bsse_type</code> as it cannot produce savings.</td>
<td>False</td>
</tr>
<tr>
<td>task_list</td>
<td>typing.Any</td>
<td>False</td>
<td></td>
<td>{}</td>
</tr>
<tr>
<td>qcmb_core</td>
<td>typing.Any</td>
<td>False</td>
<td>Low-level interface</td>
<td>None</td>
</tr>
</tbody>
</table>


<div class="doc doc-object doc-module">



<h2 id="qcmanybody.utils" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">qcmanybody.utils</span>


</h2>

    <div class="doc doc-contents first">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="qcmanybody.utils.all_same_shape" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">all_same_shape</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">all_same_shape</span><span class="p">(</span><span class="n">it</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Iterable" href="https://docs.python.org/3/library/typing.html#typing.Iterable">Iterable</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Check if all elements of an iterable have the same shape.</p>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">all_same_shape</span><span class="p">(</span><span class="n">it</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if all elements of an iterable have the same shape.&quot;&quot;&quot;</span>

    <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">first</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">it</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">first</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">it</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected float or np.ndarray, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">first</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="qcmanybody.utils.resize_gradient" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">resize_gradient</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">resize_gradient</span><span class="p">(</span><span class="n">grad</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></span><span class="p">,</span> <span class="n">bas</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">fragment_size_dict</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">],</span> <span class="n">fragment_slice_dict</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#slice">slice</a></span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">reverse</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Pads or extracts a gradient array between subsystem and full supersystem sizes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>grad</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Gradient matrix of natural size for <em>bas</em>, (3 * <em>&lt;nat in bas&gt;</em>, 3).
If <code>reverse=True</code>, gradient matrix of supersystem size, (3 * <em>&lt;nat of all fragments&gt;</em>, 3).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bas</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, ...]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>1-indexed fragments active in <em>grad</em>.
If <code>reverse=True</code>, 1-indexed fragments to be extracted from <em>grad</em>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fragment_size_dict</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the number of atoms of each 1-indexed fragment.
For He--HOOH--Me cluster, <code>{1: 1, 2: 4, 3: 5}</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fragment_slice_dict</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#slice">slice</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing slices that index the gradient matrix for each of the 1-indexed fragments.
For He--HOOH--Me cluster, <code>{1: slice(0, 1), 2: slice(1, 5), 3: slice(5, 10)}</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reverse</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, contract <em>grad</em> from supersystem size and shape to that which is natural for <em>bas</em>.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Gradient array padded with zeros to supersystem size, (3 * <em>&lt;nat of supersystem&gt;</em>, 3).
If reverse=True, gradient array extracted to natural size, (3 * <em>&lt;nat in bas&gt;</em>, 3).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">resize_gradient</span><span class="p">(</span>
    <span class="n">grad</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">bas</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">fragment_size_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">fragment_slice_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Pads or extracts a gradient array between subsystem and full supersystem sizes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grad</span>
<span class="sd">        Gradient matrix of natural size for *bas*, (3 * _&lt;nat in bas\&gt;_, 3).</span>
<span class="sd">        If `reverse=True`, gradient matrix of supersystem size, (3 * _&lt;nat of all fragments\&gt;_, 3).</span>
<span class="sd">    bas</span>
<span class="sd">        1-indexed fragments active in *grad*.</span>
<span class="sd">        If `reverse=True`, 1-indexed fragments to be extracted from *grad*.</span>
<span class="sd">    fragment_size_dict</span>
<span class="sd">        Dictionary containing the number of atoms of each 1-indexed fragment.</span>
<span class="sd">        For He--HOOH--Me cluster, `{1: 1, 2: 4, 3: 5}`.</span>
<span class="sd">    fragment_slice_dict</span>
<span class="sd">        Dictionary containing slices that index the gradient matrix for each of the 1-indexed fragments.</span>
<span class="sd">        For He--HOOH--Me cluster, `{1: slice(0, 1), 2: slice(1, 5), 3: slice(5, 10)}`.</span>
<span class="sd">    reverse</span>
<span class="sd">        If True, contract *grad* from supersystem size and shape to that which is natural for *bas*.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Gradient array padded with zeros to supersystem size, (3 * _&lt;nat of supersystem\&gt;_, 3).</span>
<span class="sd">        If reverse=True, gradient array extracted to natural size, (3 * _&lt;nat in bas\&gt;_, 3).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
        <span class="n">nat</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fragment_size_dict</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span> <span class="k">for</span> <span class="n">ifr</span> <span class="ow">in</span> <span class="n">bas</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nat</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fragment_size_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ifr</span> <span class="ow">in</span> <span class="n">bas</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">fragment_size_dict</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">grad</span><span class="p">[</span><span class="n">fragment_slice_dict</span><span class="p">[</span><span class="n">ifr</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">fragment_slice_dict</span><span class="p">[</span><span class="n">ifr</span><span class="p">]]</span> <span class="o">=</span> <span class="n">grad</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="n">start</span> <span class="o">+=</span> <span class="n">fragment_size_dict</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="qcmanybody.utils.resize_hessian" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">resize_hessian</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">resize_hessian</span><span class="p">(</span><span class="n">hess</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></span><span class="p">,</span> <span class="n">bas</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">fragment_size_dict</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">],</span> <span class="n">fragment_slice_dict</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#slice">slice</a></span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">reverse</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Pads or extracts a Hessian array between subsystem and full supersystem sizes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>hess</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hessian matrix of natural size for <em>bas</em>, (3 * <em>&lt;nat in bas&gt;</em>, 3 * <em>&lt;nat in bas&gt;</em>).
If <code>reverse=True</code>, Hessian matrix of supersystem size, (3 * <em>&lt;nat of all fragments&gt;</em>,
3 * <em>&lt;nat of all fragments&gt;</em>).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bas</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, ...]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>1-indexed fragments active in <em>hess</em>.
If <code>reverse=True</code>, 1-indexed fragments to be extracted from <em>hess</em>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fragment_size_dict</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the number of atoms of each 1-indexed fragment.
For He--HOOH--Me cluster, <code>{1: 1, 2: 4, 3: 5}</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fragment_slice_dict</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#slice">slice</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing slices that index the gradient matrix for each of the 1-indexed fragments.
For He--HOOH--Me cluster, <code>{1: slice(0, 1), 2: slice(1, 5), 3: slice(5, 10)}</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reverse</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, contract <em>hess</em> from supersystem size and shape to that which is natural for <em>bas</em>.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hessian array padded with zeros to supersystem size, (3 * <em>&lt;nat of supersystem&gt;</em>,
3 * <em>&lt;nat of supersystem&gt;</em>). If reverse=True, Hessian array extracted to natural size,
(3 * <em>&lt;nat in bas&gt;</em>, 3 * <em>&lt;nat in bas&gt;</em>).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">resize_hessian</span><span class="p">(</span>
    <span class="n">hess</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">bas</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">fragment_size_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">fragment_slice_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Pads or extracts a Hessian array between subsystem and full supersystem sizes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hess</span>
<span class="sd">        Hessian matrix of natural size for *bas*, (3 * _&lt;nat in bas\&gt;_, 3 * _&lt;nat in bas\&gt;_).</span>
<span class="sd">        If `reverse=True`, Hessian matrix of supersystem size, (3 * _&lt;nat of all fragments\&gt;_,</span>
<span class="sd">        3 * _&lt;nat of all fragments\&gt;_).</span>
<span class="sd">    bas</span>
<span class="sd">        1-indexed fragments active in *hess*.</span>
<span class="sd">        If `reverse=True`, 1-indexed fragments to be extracted from *hess*.</span>
<span class="sd">    fragment_size_dict</span>
<span class="sd">        Dictionary containing the number of atoms of each 1-indexed fragment.</span>
<span class="sd">        For He--HOOH--Me cluster, `{1: 1, 2: 4, 3: 5}`.</span>
<span class="sd">    fragment_slice_dict</span>
<span class="sd">        Dictionary containing slices that index the gradient matrix for each of the 1-indexed fragments.</span>
<span class="sd">        For He--HOOH--Me cluster, `{1: slice(0, 1), 2: slice(1, 5), 3: slice(5, 10)}`.</span>
<span class="sd">    reverse</span>
<span class="sd">        If True, contract *hess* from supersystem size and shape to that which is natural for *bas*.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Hessian array padded with zeros to supersystem size, (3 * _&lt;nat of supersystem\&gt;_,</span>
<span class="sd">        3 * _&lt;nat of supersystem\&gt;_). If reverse=True, Hessian array extracted to natural size,</span>
<span class="sd">        (3 * _&lt;nat in bas\&gt;_, 3 * _&lt;nat in bas\&gt;_).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
        <span class="n">nat</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fragment_size_dict</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span> <span class="k">for</span> <span class="n">ifr</span> <span class="ow">in</span> <span class="n">bas</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nat</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fragment_size_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nat</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">nat</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>

    <span class="c1"># Build up start and end slices</span>
    <span class="n">abs_start</span><span class="p">,</span> <span class="n">rel_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">abs_slices</span><span class="p">,</span> <span class="n">rel_slices</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ifr</span> <span class="ow">in</span> <span class="n">bas</span><span class="p">:</span>
        <span class="n">rel_end</span> <span class="o">=</span> <span class="n">rel_start</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">fragment_size_dict</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span>
        <span class="n">rel_slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">rel_start</span><span class="p">,</span> <span class="n">rel_end</span><span class="p">))</span>
        <span class="n">rel_start</span> <span class="o">+=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">fragment_size_dict</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span>

        <span class="n">tmp_slice</span> <span class="o">=</span> <span class="n">fragment_slice_dict</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span>
        <span class="n">abs_slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">tmp_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">tmp_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">abs_sl1</span><span class="p">,</span> <span class="n">rel_sl1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abs_slices</span><span class="p">,</span> <span class="n">rel_slices</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">abs_sl2</span><span class="p">,</span> <span class="n">rel_sl2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abs_slices</span><span class="p">,</span> <span class="n">rel_slices</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">rel_sl1</span><span class="p">,</span> <span class="n">rel_sl2</span><span class="p">]</span> <span class="o">=</span> <span class="n">hess</span><span class="p">[</span><span class="n">abs_sl1</span><span class="p">,</span> <span class="n">abs_sl2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">abs_sl1</span><span class="p">,</span> <span class="n">abs_sl2</span><span class="p">]</span> <span class="o">=</span> <span class="n">hess</span><span class="p">[</span><span class="n">rel_sl1</span><span class="p">,</span> <span class="n">rel_sl2</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="qcmanybody.utils.sum_cluster_data" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">sum_cluster_data</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">sum_cluster_data</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></span><span class="p">]],</span> <span class="n">compute_list</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Set" href="https://docs.python.org/3/library/typing.html#typing.Set">Set</a></span><span class="p">[</span><span class="s1">&#39;FragBasIndex&#39;</span><span class="p">],</span> <span class="n">mc_level_lbl</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n">vmfc</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">nb</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Sum (direct or alternate weight by n-body) like data from</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing computed property (e/g/H/etc.) for each subsystem/component computation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compute_list</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Set" href="https://docs.python.org/3/library/typing.html#typing.Set">Set</a>[&#39;FragBasIndex&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of (frag, bas) tuples notating all the required computations for the desired sum.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mc_level_lbl</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>User label for what modelchem level results should be pulled out of <em>data</em>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vmfc</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Is this a vmfc calculation, by default False?</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nb</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>1-indexed n-body level only used when <code>vmfc=True</code>, by default 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scalar or array containing summed energy, gradient, Hessian, or other result.
Usually (nocp or cp; <code>vmfc=False</code>), compute_list defines all fragments of a given number of
active fragments and active basis fragments, so the return is the 3b@3b sum, for example.
Other times (<code>vmfc=True</code>), compute list defines all fragments of a given number of active basis
fragments. Then alternating weighting is applied so if <code>nb=3</code>, the return is the quantity
(3b@3b sum - 2b@3b sum + 1b@3b sum), for example.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the shapes of all the <code>data</code> values aren't the same. No summing energies with gradients.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sum_cluster_data</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span>
    <span class="n">compute_list</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="s2">&quot;FragBasIndex&quot;</span><span class="p">],</span>
    <span class="n">mc_level_lbl</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">vmfc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">nb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sum (direct or alternate weight by n-body) like data from</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data</span>
<span class="sd">        Dictionary containing computed property (e/g/H/etc.) for each subsystem/component computation.</span>
<span class="sd">    compute_list</span>
<span class="sd">        A list of (frag, bas) tuples notating all the required computations for the desired sum.</span>
<span class="sd">    mc_level_lbl</span>
<span class="sd">        User label for what modelchem level results should be pulled out of *data*.</span>
<span class="sd">    vmfc</span>
<span class="sd">        Is this a vmfc calculation, by default False?</span>
<span class="sd">    nb</span>
<span class="sd">        1-indexed n-body level only used when `vmfc=True`, by default 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Union[float, np.ndarray]</span>
<span class="sd">        Scalar or array containing summed energy, gradient, Hessian, or other result.</span>
<span class="sd">        Usually (nocp or cp; `vmfc=False`), compute_list defines all fragments of a given number of</span>
<span class="sd">        active fragments and active basis fragments, so the return is the 3b@3b sum, for example.</span>
<span class="sd">        Other times (`vmfc=True`), compute list defines all fragments of a given number of active basis</span>
<span class="sd">        fragments. Then alternating weighting is applied so if `nb=3`, the return is the quantity</span>
<span class="sd">        (3b@3b sum - 2b@3b sum + 1b@3b sum), for example.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the shapes of all the `data` values aren&#39;t the same. No summing energies with gradients.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_same_shape</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All values in data dictionary must have the same shape.&quot;</span><span class="p">)</span>

    <span class="n">first_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">find_shape</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">first_key</span><span class="p">])</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">shaped_zero</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># np.sum might be preferable for precision for G/H but np.sum(generator) ill-defined</span>
    <span class="n">precise_sum_func</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fsum</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="nb">sum</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">precise_sum_func</span><span class="p">(</span>
        <span class="p">(((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">nb</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">frag</span><span class="p">)))</span> <span class="k">if</span> <span class="n">vmfc</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">labeler</span><span class="p">(</span><span class="n">mc_level_lbl</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="n">bas</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">frag</span><span class="p">,</span> <span class="n">bas</span> <span class="ow">in</span> <span class="n">compute_list</span>
    <span class="p">)</span>

    <span class="c1"># A more readable format for the above but not ammenable to using specialty summation functions</span>
    <span class="c1"># ```</span>
    <span class="c1"># for frag, bas in compute_list:</span>
    <span class="c1">#     egh = data[labeler(mc_level_lbl, frag, bas)]</span>
    <span class="c1">#</span>
    <span class="c1">#     if vmfc:</span>
    <span class="c1">#         sign = (-1) ** (nb - len(frag))</span>
    <span class="c1">#</span>
    <span class="c1">#     ret += sign * egh</span>
    <span class="c1"># ```</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="qcmanybody.utils.labeler" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">labeler</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">labeler</span><span class="p">(</span><span class="n">mc_level_lbl</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">]],</span> <span class="n">frag</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">bas</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">opaque</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Form label from model chemistry id and fragment and basis indices.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mc_level_lbl</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key identifying the model chemistry. May be <code>"(auto)"</code>. Often the
ManyBodyInput.specification.specification keys.
When <code>opaque=False</code>, result is for pretty printing so instead of a string,
<code>mc_level_lbl</code> might be an integer index (apply 1-indexing beforehand)
or None (if the model chemistry part is unwanted because single-level).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frag</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, ...]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of 1-indexed fragments active in the supersystem.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bas</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, ...]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of 1-indexed fragments with active basis sets in the supersystem.
All those in <em>frag</em> plus any ghost.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>opaque</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Toggle whether to return JSON-friendly semi-opaque internal str label (True) or
eye-friendly label with @ for basis and  for model chemistry (False).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON string from inputs:</p>
<div class="highlight"><pre><span></span><code><span class="n">labeler</span><span class="p">(</span><span class="s2">&quot;mp2&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="c1">#&gt; &#39;[&quot;mp2&quot;, [1], [1, 2]]&#39;</span>
<span class="n">labeler</span><span class="p">(</span><span class="s2">&quot;mp2&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">opaque</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#&gt; &#39;mp2_(1)@(1, 2)&#39;</span>
</code></pre></div>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">labeler</span><span class="p">(</span>
    <span class="n">mc_level_lbl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">frag</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">bas</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">opaque</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Form label from model chemistry id and fragment and basis indices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mc_level_lbl</span>
<span class="sd">        Key identifying the model chemistry. May be `&quot;(auto)&quot;`. Often the</span>
<span class="sd">        ManyBodyInput.specification.specification keys.</span>
<span class="sd">        When `opaque=False`, result is for pretty printing so instead of a string,</span>
<span class="sd">        `mc_level_lbl` might be an integer index (apply 1-indexing beforehand)</span>
<span class="sd">        or None (if the model chemistry part is unwanted because single-level).</span>
<span class="sd">    frag</span>
<span class="sd">        List of 1-indexed fragments active in the supersystem.</span>
<span class="sd">    bas</span>
<span class="sd">        List of 1-indexed fragments with active basis sets in the supersystem.</span>
<span class="sd">        All those in *frag* plus any ghost.</span>
<span class="sd">    opaque</span>
<span class="sd">        Toggle whether to return JSON-friendly semi-opaque internal str label (True) or</span>
<span class="sd">        eye-friendly label with @ for basis and  for model chemistry (False).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        JSON string from inputs:</span>

<span class="sd">        ```python</span>
<span class="sd">        labeler(&quot;mp2&quot;, 1, (1, 2))</span>
<span class="sd">        #&gt; &#39;[&quot;mp2&quot;, [1], [1, 2]]&#39;</span>
<span class="sd">        labeler(&quot;mp2&quot;, 1, (1, 2), opaque=False)</span>
<span class="sd">        #&gt; &#39;mp2_(1)@(1, 2)&#39;</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">frag</span> <span class="o">=</span> <span class="p">(</span><span class="n">frag</span><span class="p">,)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bas</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">bas</span> <span class="o">=</span> <span class="p">(</span><span class="n">bas</span><span class="p">,)</span>

    <span class="k">if</span> <span class="n">opaque</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">mc_level_lbl</span><span class="p">),</span> <span class="n">frag</span><span class="p">,</span> <span class="n">bas</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mc_pre</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">mc_level_lbl</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mc_level_lbl</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mc_pre</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">frag</span><span class="p">))</span><span class="si">}</span><span class="s2">)@(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">bas</span><span class="p">))</span><span class="si">}</span><span class="s2">)&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="qcmanybody.utils.delabeler" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">delabeler</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">delabeler</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Back-form from label into tuple.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="mcfragbas">mcfragbas</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of opaque or pretty-print model chemistry (may be None for latter),
fragments and bases (1-indexed by convention).</p>
<div class="highlight"><pre><span></span><code><span class="n">delabeler</span><span class="p">(</span><span class="s1">&#39;[&quot;mp2&quot;, [1], [1, 2]]&#39;</span><span class="p">)</span>
<span class="c1">#&gt; (&#39;mp2&#39;, [1], [1, 2])</span>
<span class="n">delabeler</span><span class="p">(</span><span class="s2">&quot;mp2_(1)@(1, 2)&quot;</span><span class="p">)</span>
<span class="c1">#&gt; (&#39;mp2&#39;, [1], [1, 2])</span>
</code></pre></div>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">delabeler</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Back-form from label into tuple.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mcfragbas</span>
<span class="sd">        Tuple of opaque or pretty-print model chemistry (may be None for latter),</span>
<span class="sd">        fragments and bases (1-indexed by convention).</span>

<span class="sd">        ```python</span>
<span class="sd">        delabeler(&#39;[&quot;mp2&quot;, [1], [1, 2]]&#39;)</span>
<span class="sd">        #&gt; (&#39;mp2&#39;, [1], [1, 2])</span>
<span class="sd">        delabeler(&quot;mp2_(1)@(1, 2)&quot;)</span>
<span class="sd">        #&gt; (&#39;mp2&#39;, [1], [1, 2])</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
        <span class="n">mc</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="n">bas</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">mc</span><span class="p">),</span> <span class="n">frag</span><span class="p">,</span> <span class="n">bas</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mobj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:(?P&lt;mc&gt;\S*)_)?(?P&lt;frag&gt;.*)@(?P&lt;bas&gt;.*)&quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="n">mc</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="n">bas</span> <span class="o">=</span> <span class="n">mobj</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
        <span class="c1"># want lists and avoids (1) non-iterable error</span>
        <span class="n">frag</span> <span class="o">=</span> <span class="n">frag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
        <span class="n">bas</span> <span class="o">=</span> <span class="n">bas</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mc</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">bas</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="qcmanybody.utils.print_nbody_energy" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">print_nbody_energy</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">print_nbody_energy</span><span class="p">(</span><span class="n">energy_body_dict</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Mapping" href="https://docs.python.org/3/library/typing.html#typing.Mapping">Mapping</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></span><span class="p">],</span> <span class="n">header</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n">nfragments</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n">modelchem_labels</span><span class="p">,</span> <span class="n">embedding</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span><span class="p">,</span> <span class="n">supersystem_ie_only</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span><span class="p">,</span> <span class="n">supersystem_beyond</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Format summary string for energies of a single bsse_type. Logs and returns output.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>energy_body_dict</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Mapping" href="https://docs.python.org/3/library/typing.html#typing.Mapping">Mapping</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>header</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specialization for table title.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nfragments</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of lines in table is number of fragments.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>modelchem_labels</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping active nbody-levels to a tuple with first element the
full model chemistry key and second element a short label. A suitable
dictionary is <code>modelchem_labels(manybodycore_instance.nbodies_per_mc_level)</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>embedding</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether charge embedding present suppress printing, usually False</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>supersystem_ie_only</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether only 1-body and nfragments-body levels are available, usually False.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>supersystem_beyond</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If not None, the number of nbody-levels computed by MBE explicitly. Beyond this gets supersystem SS label.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A text table in Hartrees and kcal/mol</p>
<div class="highlight"><pre><span></span><code>==&gt; N-Body: Counterpoise Corrected (CP) energies &lt;==&#39;

        n-Body     Total Energy            Interaction Energy                          N-body Contribution to Interaction Energy&#39;
                   [Eh]                    [Eh]                  [kcal/mol]            [Eh]                  [kcal/mol]&#39;
             1     -386.455609352609        0.000000000000        0.000000000000        0.000000000000        0.000000000000&#39;
             2     -384.203153844163        2.252455508446     1413.437170812134        2.252455508446     1413.437170812134&#39;
  FULL/RTN   3     -384.128628718676        2.326980633933     1460.202393089624        0.074525125487       46.765222277490&#39;
</code></pre></div>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">print_nbody_energy</span><span class="p">(</span>
    <span class="n">energy_body_dict</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">header</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">nfragments</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">modelchem_labels</span><span class="p">,</span>
    <span class="n">embedding</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">supersystem_ie_only</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">supersystem_beyond</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format summary string for energies of a single bsse_type. Logs and returns output.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    energy_body_dict</span>
<span class="sd">        Input data.</span>
<span class="sd">    header</span>
<span class="sd">        Specialization for table title.</span>
<span class="sd">    nfragments</span>
<span class="sd">        Number of lines in table is number of fragments.</span>
<span class="sd">    modelchem_labels</span>
<span class="sd">        Dictionary mapping active nbody-levels to a tuple with first element the</span>
<span class="sd">        full model chemistry key and second element a short label. A suitable</span>
<span class="sd">        dictionary is `modelchem_labels(manybodycore_instance.nbodies_per_mc_level)`.</span>
<span class="sd">    embedding</span>
<span class="sd">        Whether charge embedding present suppress printing, usually False</span>
<span class="sd">    supersystem_ie_only</span>
<span class="sd">        Whether only 1-body and nfragments-body levels are available, usually False.</span>
<span class="sd">    supersystem_beyond</span>
<span class="sd">        If not None, the number of nbody-levels computed by MBE explicitly. Beyond this gets supersystem SS label.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        A text table in Hartrees and kcal/mol</span>

<span class="sd">        ```</span>
<span class="sd">        ==&gt; N-Body: Counterpoise Corrected (CP) energies &lt;==&#39;</span>

<span class="sd">                n-Body     Total Energy            Interaction Energy                          N-body Contribution to Interaction Energy&#39;</span>
<span class="sd">                           [Eh]                    [Eh]                  [kcal/mol]            [Eh]                  [kcal/mol]&#39;</span>
<span class="sd">                     1     -386.455609352609        0.000000000000        0.000000000000        0.000000000000        0.000000000000&#39;</span>
<span class="sd">                     2     -384.203153844163        2.252455508446     1413.437170812134        2.252455508446     1413.437170812134&#39;</span>
<span class="sd">          FULL/RTN   3     -384.128628718676        2.326980633933     1460.202393089624        0.074525125487       46.765222277490&#39;</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s2">   ==&gt; N-Body: </span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2"> energies &lt;==</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span>
    <span class="n">info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;        </span><span class="si">{</span><span class="s2">&quot;MC n-Body&quot;</span><span class="si">:</span><span class="s2">&gt;15</span><span class="si">}</span><span class="s2">  Total Energy            Interaction Energy                          N-body Contribution to Interaction Energy</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
    <span class="n">info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;                         [Eh]                    [Eh]                  [kcal/mol]            [Eh]                  [kcal/mol]</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
    <span class="n">previous_e</span> <span class="o">=</span> <span class="n">energy_body_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">tot_e</span> <span class="o">=</span> <span class="n">previous_e</span> <span class="o">!=</span> <span class="mf">0.0</span>
    <span class="n">nbody_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">energy_body_dict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">supersystem_ie_only</span><span class="p">:</span>
        <span class="n">nbody_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">nfragments</span><span class="p">]</span>
    <span class="n">nbody_range</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nfragments</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">lbl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">supersystem_beyond</span> <span class="ow">and</span> <span class="n">nb</span> <span class="o">&gt;</span> <span class="n">supersystem_beyond</span><span class="p">:</span>
            <span class="n">lbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;SS&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nb</span> <span class="o">==</span> <span class="n">nfragments</span><span class="p">:</span>
            <span class="n">lbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;FULL&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nb</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">nbody_range</span><span class="p">):</span>
            <span class="n">lbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RTN&quot;</span><span class="p">)</span>
        <span class="n">lbl</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lbl</span><span class="p">)</span>

        <span class="n">mclbl</span> <span class="o">=</span> <span class="n">modelchem_labels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">nbody_range</span><span class="p">:</span>
            <span class="n">delta_e</span> <span class="o">=</span> <span class="n">energy_body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous_e</span>
            <span class="n">delta_e_kcal</span> <span class="o">=</span> <span class="n">delta_e</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">hartree2kcalmol</span>
            <span class="k">if</span> <span class="n">embedding</span><span class="p">:</span>
                <span class="n">int_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">int_e_kcal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">int_e</span> <span class="o">=</span> <span class="n">energy_body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">-</span> <span class="n">energy_body_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">int_e_kcal</span> <span class="o">=</span> <span class="n">int_e</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">hartree2kcalmol</span>
            <span class="k">if</span> <span class="n">supersystem_ie_only</span> <span class="ow">and</span> <span class="n">nb</span> <span class="o">==</span> <span class="n">nfragments</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tot_e</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;  </span><span class="si">{</span><span class="n">lbl</span><span class="si">:</span><span class="s2">&gt;11</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mclbl</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">nb</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">energy_body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">int_e</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">int_e_kcal</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="s2">        </span><span class="si">{</span><span class="s2">&quot;N/A&quot;</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="s2">&quot;N/A&quot;</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;  </span><span class="si">{</span><span class="n">lbl</span><span class="si">:</span><span class="s2">&gt;11</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mclbl</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">nb</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2">        </span><span class="si">{</span><span class="s2">&quot;N/A&quot;</span><span class="si">:</span><span class="s2">14</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">int_e</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">int_e_kcal</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="s2">        </span><span class="si">{</span><span class="s2">&quot;N/A&quot;</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="s2">&quot;N/A&quot;</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tot_e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">embedding</span><span class="p">:</span>
                        <span class="n">info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;  </span><span class="si">{</span><span class="n">lbl</span><span class="si">:</span><span class="s2">&gt;11</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mclbl</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">nb</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">energy_body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="s2">        </span><span class="si">{</span><span class="s2">&quot;N/A&quot;</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="s2">&quot;N/A&quot;</span><span class="si">:</span><span class="s2">14</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">delta_e</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">delta_e_kcal</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;  </span><span class="si">{</span><span class="n">lbl</span><span class="si">:</span><span class="s2">&gt;11</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mclbl</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">nb</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">energy_body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">int_e</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">int_e_kcal</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">delta_e</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">delta_e_kcal</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;  </span><span class="si">{</span><span class="n">lbl</span><span class="si">:</span><span class="s2">&gt;11</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mclbl</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">nb</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2">        </span><span class="si">{</span><span class="s2">&quot;N/A&quot;</span><span class="si">:</span><span class="s2">14</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">int_e</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">int_e_kcal</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">delta_e</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">delta_e_kcal</span><span class="si">:</span><span class="s2">20.12f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">previous_e</span> <span class="o">=</span> <span class="n">energy_body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;  </span><span class="si">{</span><span class="n">lbl</span><span class="si">:</span><span class="s2">&gt;11</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s2">&quot;&quot;</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">nb</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2">        </span><span class="si">{</span><span class="s2">&quot;N/A&quot;</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="s2">&quot;N/A&quot;</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="s2">&quot;N/A&quot;</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="s2">&quot;N/A&quot;</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="s2">&quot;N/A&quot;</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>

    <span class="n">mc_legend</span> <span class="o">=</span> <span class="p">{</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">modelchem_labels</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
    <span class="n">mc_legend</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: &quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mc_legend</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   MC Legend: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mc_legend</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">info</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="qcmanybody.utils.collect_vars" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">collect_vars</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">collect_vars</span><span class="p">(</span><span class="n">bsse</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n">prop</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n">body_dict</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Mapping" href="https://docs.python.org/3/library/typing.html#typing.Mapping">Mapping</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></span><span class="p">]],</span> <span class="n">max_nbody</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n">embedding</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">supersystem_ie_only</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">has_supersystem</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>From <em>body_dict</em>, construct data for ManyBodyResultProperties.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>bsse</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Label for a single many-body treatment, generally a value of BsseEnum.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prop</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Label for a single property, generally a value of DriverEnum.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>body_dict</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Mapping" href="https://docs.python.org/3/library/typing.html#typing.Mapping">Mapping</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>, <a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of minimal per-body info already specialized for property <em>prop</em> and treatment
<em>bsse</em>. May contain either total data or interaction data (cummulative, not additive) from
1-body to max_nbody-body (see also <em>supersystem_ie_only</em>). Interaction data signaled by zero
float or array for 1-body. May contain data from multiple model chemistry levels.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_nbody</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>description</em></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>embedding</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Is charge embedding enabled, by default False?</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>supersystem_ie_only</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Is data available in <em>body_dict</em> only for 1-body (possibly zero) and nfr-body levels?
By default False: data is available for consecutive levels, up to max_nbody-body.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>has_supersystem</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether contributions higher than max_nbody are a summary correction.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>description</em>. Empty return if <em>embedding</em> enabled.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">collect_vars</span><span class="p">(</span>
    <span class="n">bsse</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">body_dict</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span>
    <span class="n">max_nbody</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">supersystem_ie_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">has_supersystem</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;From *body_dict*, construct data for ManyBodyResultProperties.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bsse</span>
<span class="sd">        Label for a single many-body treatment, generally a value of BsseEnum.</span>
<span class="sd">    prop</span>
<span class="sd">        Label for a single property, generally a value of DriverEnum.</span>
<span class="sd">    body_dict</span>
<span class="sd">        Dictionary of minimal per-body info already specialized for property *prop* and treatment</span>
<span class="sd">        *bsse*. May contain either total data or interaction data (cummulative, not additive) from</span>
<span class="sd">        1-body to max_nbody-body (see also *supersystem_ie_only*). Interaction data signaled by zero</span>
<span class="sd">        float or array for 1-body. May contain data from multiple model chemistry levels.</span>
<span class="sd">    max_nbody</span>
<span class="sd">        _description_</span>
<span class="sd">    embedding</span>
<span class="sd">        Is charge embedding enabled, by default False?</span>
<span class="sd">    supersystem_ie_only</span>
<span class="sd">        Is data available in *body_dict* only for 1-body (possibly zero) and nfr-body levels?</span>
<span class="sd">        By default False: data is available for consecutive levels, up to max_nbody-body.</span>
<span class="sd">    has_supersystem</span>
<span class="sd">        Whether contributions higher than max_nbody are a summary correction.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        _description_. Empty return if *embedding* enabled.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bsse</span> <span class="o">=</span> <span class="n">bsse</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">previous_e</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">property_shape</span> <span class="o">=</span> <span class="n">find_shape</span><span class="p">(</span><span class="n">previous_e</span><span class="p">)</span>
    <span class="n">tot_e</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">previous_e</span><span class="p">))</span>
    <span class="n">nbody_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">body_dict</span><span class="p">)</span>
    <span class="n">nbody_range</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">tot_e</span><span class="p">:</span>
        <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_total_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">max_nbody</span><span class="p">]</span>
    <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_interaction_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">max_nbody</span><span class="p">]</span> <span class="o">-</span> <span class="n">body_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_interaction_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">_through_1_body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shaped_zero</span><span class="p">(</span><span class="n">property_shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">supersystem_ie_only</span><span class="p">:</span>
        <span class="n">nfr</span> <span class="o">=</span> <span class="n">nbody_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="p">[</span><span class="n">nfr</span><span class="p">]:</span>
            <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_interaction_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">_through_</span><span class="si">{</span><span class="n">nb</span><span class="si">}</span><span class="s2">_body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">-</span> <span class="n">body_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nb</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_</span><span class="si">{</span><span class="n">nb</span><span class="si">}</span><span class="s2">_body_contribution_to_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">-</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tot_e</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">nfr</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_total_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">_through_</span><span class="si">{</span><span class="n">nb</span><span class="si">}</span><span class="s2">_body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">has_supersystem</span><span class="p">:</span>
        <span class="n">nfr</span> <span class="o">=</span> <span class="n">nbody_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_interaction_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nfr</span><span class="p">]</span> <span class="o">-</span> <span class="n">body_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># reset</span>
        <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_nbody</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_interaction_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">_through_</span><span class="si">{</span><span class="n">nb</span><span class="si">}</span><span class="s2">_body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">-</span> <span class="n">body_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_</span><span class="si">{</span><span class="n">nb</span><span class="si">}</span><span class="s2">_body_contribution_to_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">-</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="p">[</span><span class="n">nfr</span><span class="p">]:</span>
            <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_interaction_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">_through_</span><span class="si">{</span><span class="n">nb</span><span class="si">}</span><span class="s2">_body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">-</span> <span class="n">body_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_</span><span class="si">{</span><span class="n">nb</span><span class="si">}</span><span class="s2">_body_contribution_to_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">-</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">max_nbody</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tot_e</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_total_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nfr</span><span class="p">]</span>  <span class="c1"># reset</span>
            <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">nbody_range</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_total_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">_through_</span><span class="si">{</span><span class="n">nb</span><span class="si">}</span><span class="s2">_body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">nbody_range</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_interaction_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">_through_</span><span class="si">{</span><span class="n">nb</span><span class="si">}</span><span class="s2">_body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">-</span> <span class="n">body_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_</span><span class="si">{</span><span class="n">nb</span><span class="si">}</span><span class="s2">_body_contribution_to_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">-</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tot_e</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">nbody_range</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsse</span><span class="si">}</span><span class="s2">_corrected_total_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">_through_</span><span class="si">{</span><span class="n">nb</span><span class="si">}</span><span class="s2">_body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_dict</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">embedding</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;interaction&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="qcmanybody.utils.provenance_stamp" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">provenance_stamp</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">provenance_stamp</span><span class="p">(</span><span class="n">routine</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return dictionary satisfying QCSchema,
https://github.com/MolSSI/QCSchema/blob/master/qcschema/dev/definitions.py#L23-L41
with QCManyBody's credentials for creator and version. The
generating routine's name is passed in through <code>routine</code>.</p>
<div class="highlight"><pre><span></span><code><span class="n">qcmb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">provenance_stamp</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="c1">#&gt; {&#39;creator&#39;: &#39;QCManyBody&#39;, &#39;version&#39;: &#39;0.2.2&#39;, &#39;routine&#39;: &#39;__main__&#39;}</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">provenance_stamp</span><span class="p">(</span><span class="n">routine</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return dictionary satisfying QCSchema,</span>
<span class="sd">    https://github.com/MolSSI/QCSchema/blob/master/qcschema/dev/definitions.py#L23-L41</span>
<span class="sd">    with QCManyBody&#39;s credentials for creator and version. The</span>
<span class="sd">    generating routine&#39;s name is passed in through `routine`.</span>

<span class="sd">    ```python</span>
<span class="sd">    qcmb.utils.provenance_stamp(__name__)</span>
<span class="sd">    #&gt; {&#39;creator&#39;: &#39;QCManyBody&#39;, &#39;version&#39;: &#39;0.2.2&#39;, &#39;routine&#39;: &#39;__main__&#39;}</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">qcmanybody</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;creator&quot;</span><span class="p">:</span> <span class="s2">&quot;QCManyBody&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">qcmanybody</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span> <span class="s2">&quot;routine&quot;</span><span class="p">:</span> <span class="n">routine</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="qcmanybody.utils.translate_qcvariables" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">translate_qcvariables</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">translate_qcvariables</span><span class="p">(</span><span class="n">varsmap</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Mapping" href="https://docs.python.org/3/library/typing.html#typing.Mapping">Mapping</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Translate between ManyBody results in Psi4/QCDB terminology (qcvars) and QCSchema terminology (skprops).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>varsmap</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Mapping" href="https://docs.python.org/3/library/typing.html#typing.Mapping">Mapping</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.Any" href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with keys all members of QCVariables or ManyBodyResultProperties and arbitrary values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>varsmap with keys swapped to other set. Untranslatable keys are omitted.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">translate_qcvariables</span><span class="p">(</span><span class="n">varsmap</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Translate between ManyBody results in Psi4/QCDB terminology (qcvars) and QCSchema terminology (skprops).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    varsmap</span>
<span class="sd">        Dictionary with keys all members of QCVariables or ManyBodyResultProperties and arbitrary values.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        varsmap with keys swapped to other set. Untranslatable keys are omitted.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">qcmanybody.models.v1</span><span class="w"> </span><span class="kn">import</span> <span class="n">ManyBodyResultProperties</span>

    <span class="c1"># identify direction of translation</span>
    <span class="n">qcv2skp</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">lbl</span> <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">varsmap</span><span class="p">])</span>
    <span class="n">labelmap</span> <span class="o">=</span> <span class="n">ManyBodyResultProperties</span><span class="o">.</span><span class="n">to_qcvariables</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="n">qcv2skp</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">labelmap</span><span class="p">[</span><span class="n">lbl</span><span class="p">]:</span> <span class="n">data</span> <span class="k">for</span> <span class="n">lbl</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">varsmap</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">labelmap</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="qcmanybody.utils.modelchem_labels" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">modelchem_labels</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">modelchem_labels</span><span class="p">(</span><span class="n">nb_per_mc</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Literal" href="https://docs.python.org/3/library/typing.html#typing.Literal">Literal</a></span><span class="p">[</span><span class="s1">&#39;supersystem&#39;</span><span class="p">]]]],</span> <span class="n">presorted</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Literal" href="https://docs.python.org/3/library/typing.html#typing.Literal">Literal</a></span><span class="p">[</span><span class="s1">&#39;supersystem&#39;</span><span class="p">]],</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Tuple" href="https://docs.python.org/3/library/typing.html#typing.Tuple">Tuple</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">]]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Form ordinal and letter labels for model chemistries.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>nb_per_mc</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" title="typing.List" href="https://docs.python.org/3/library/typing.html#typing.List">List</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" title="typing.Literal" href="https://docs.python.org/3/library/typing.html#typing.Literal">Literal</a>[&#39;supersystem&#39;]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping model chemistries to lists of n-body levels computed.
If a model chemistry is supersystem, the value should be ["supersystem"].
Generally, this is the <code>ManyBodyCore.nbodies_per_mc_level</code> data structure.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>presorted</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, the input dictionary keys and values are already sorted by increasing n-body level.
This is the case when the input is <code>ManyBodyCore.nbodies_per_mc_level</code>.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="mc_per_nb">mc_per_nb</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping n-body levels to a tuple of full model chemistry label,
single-letter ordinal label, and n-body-levels-covered label.</p>
<div class="highlight"><pre><span></span><code><span class="n">modelchem_labels</span><span class="p">({</span><span class="s1">&#39;ccsd&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;mp2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;hf&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]})</span>
<span class="c1">#&gt; {1: (&#39;ccsd&#39;, &#39;A&#39;, &#39;1&#39;), 2: (&#39;mp2&#39;, &#39;B&#39;, &#39;23&#39;), 3: (&#39;mp2&#39;, &#39;B&#39;, &#39;23&#39;), 4: (&#39;hf&#39;, &#39;C&#39;, &#39;4&#39;)}</span>

<span class="n">modelchem_labels</span><span class="p">({</span><span class="s1">&#39;hi&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;md&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;md2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="s1">&#39;lo&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;supersystem&#39;</span><span class="p">]})</span>
<span class="c1">#&gt; {1: (&#39;hi&#39;, &#39;A&#39;, &#39;123&#39;), 2: (&#39;hi&#39;, &#39;A&#39;, &#39;123&#39;), 3: (&#39;hi&#39;, &#39;A&#39;, &#39;123&#39;),</span>
<span class="c1">#   4: (&#39;md&#39;, &#39;B&#39;, &#39;4&#39;),</span>
<span class="c1">#   5: (&#39;md2&#39;, &#39;C&#39;, &#39;&lt;10&#39;), 6: (&#39;md2&#39;, &#39;C&#39;, &#39;&lt;10&#39;), 7: (&#39;md2&#39;, &#39;C&#39;, &#39;&lt;10&#39;), 8: (&#39;md2&#39;, &#39;C&#39;, &#39;&lt;10&#39;), 9: (&#39;md2&#39;, &#39;C&#39;, &#39;&lt;10&#39;), 10: (&#39;md2&#39;, &#39;C&#39;, &#39;&lt;10&#39;),</span>
<span class="c1">#   &quot;supersystem&quot;: (&#39;lo&#39;, &#39;D&#39;, &#39;SS&#39;)}</span>
</code></pre></div>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">modelchem_labels</span><span class="p">(</span>
    <span class="n">nb_per_mc</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;supersystem&quot;</span><span class="p">]]]],</span> <span class="n">presorted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;supersystem&quot;</span><span class="p">]],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Form ordinal and letter labels for model chemistries.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nb_per_mc</span>
<span class="sd">        Dictionary mapping model chemistries to lists of n-body levels computed.</span>
<span class="sd">        If a model chemistry is supersystem, the value should be [&quot;supersystem&quot;].</span>
<span class="sd">        Generally, this is the `ManyBodyCore.nbodies_per_mc_level` data structure.</span>
<span class="sd">    presorted</span>
<span class="sd">        If True, the input dictionary keys and values are already sorted by increasing n-body level.</span>
<span class="sd">        This is the case when the input is `ManyBodyCore.nbodies_per_mc_level`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mc_per_nb</span>
<span class="sd">        Dictionary mapping n-body levels to a tuple of full model chemistry label,</span>
<span class="sd">        single-letter ordinal label, and n-body-levels-covered label.</span>

<span class="sd">        ```python</span>
<span class="sd">        modelchem_labels({&#39;ccsd&#39;: [1], &#39;mp2&#39;: [2, 3], &#39;hf&#39;: [4]})</span>
<span class="sd">        #&gt; {1: (&#39;ccsd&#39;, &#39;A&#39;, &#39;1&#39;), 2: (&#39;mp2&#39;, &#39;B&#39;, &#39;23&#39;), 3: (&#39;mp2&#39;, &#39;B&#39;, &#39;23&#39;), 4: (&#39;hf&#39;, &#39;C&#39;, &#39;4&#39;)}</span>

<span class="sd">        modelchem_labels({&#39;hi&#39;: [1, 2, 3], &#39;md&#39;: [4], &#39;md2&#39;: [5, 6, 7, 8, 9, 10], &#39;lo&#39;: [&#39;supersystem&#39;]})</span>
<span class="sd">        #&gt; {1: (&#39;hi&#39;, &#39;A&#39;, &#39;123&#39;), 2: (&#39;hi&#39;, &#39;A&#39;, &#39;123&#39;), 3: (&#39;hi&#39;, &#39;A&#39;, &#39;123&#39;),</span>
<span class="sd">        #   4: (&#39;md&#39;, &#39;B&#39;, &#39;4&#39;),</span>
<span class="sd">        #   5: (&#39;md2&#39;, &#39;C&#39;, &#39;&lt;10&#39;), 6: (&#39;md2&#39;, &#39;C&#39;, &#39;&lt;10&#39;), 7: (&#39;md2&#39;, &#39;C&#39;, &#39;&lt;10&#39;), 8: (&#39;md2&#39;, &#39;C&#39;, &#39;&lt;10&#39;), 9: (&#39;md2&#39;, &#39;C&#39;, &#39;&lt;10&#39;), 10: (&#39;md2&#39;, &#39;C&#39;, &#39;&lt;10&#39;),</span>
<span class="sd">        #   &quot;supersystem&quot;: (&#39;lo&#39;, &#39;D&#39;, &#39;SS&#39;)}</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sorted_nb_per_mc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">nb_per_mc</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">mc_nbs</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">([</span><span class="mi">1000</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">mc_nbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;supersystem&quot;</span><span class="p">])</span> <span class="k">else</span> <span class="n">mc_nbs</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">presorted</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">sorted_nb_per_mc</span> <span class="o">==</span> <span class="n">nb_per_mc</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;If presorted, input dictionary should be sorted. </span><span class="si">{</span><span class="n">nb_per_mc</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">sorted_nb_per_mc</span><span class="si">}</span><span class="s2">   &quot;</span>

    <span class="n">lvl_lbl</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">mc</span><span class="p">,</span> <span class="n">nbs</span> <span class="ow">in</span> <span class="n">sorted_nb_per_mc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">nbs</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;supersystem&quot;</span><span class="p">]:</span>
            <span class="n">lvl_lbl</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SS&quot;</span>
        <span class="k">elif</span> <span class="nb">max</span><span class="p">(</span><span class="n">nbs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">lvl_lbl</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">nbs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lvl_lbl</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="nb">sorted</span><span class="p">(</span><span class="n">nbs</span><span class="p">)))</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">indexed_mc</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_nb_per_mc</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>

    <span class="n">mc_per_nb</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">nb</span><span class="p">:</span> <span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">[</span><span class="n">indexed_mc</span><span class="p">[</span><span class="n">mc</span><span class="p">]]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lvl_lbl</span><span class="p">[</span><span class="n">mc</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">mc</span><span class="p">,</span> <span class="n">nbs</span> <span class="ow">in</span> <span class="n">sorted_nb_per_mc</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">nbs</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">mc_per_nb</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="qcmanybody.builder" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">qcmanybody.builder</span>


</h2>

    <div class="doc doc-contents first">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="qcmanybody.builder.build_nbody_compute_list" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">build_nbody_compute_list</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">build_nbody_compute_list</span><span class="p">(</span><span class="n">bsse_type</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Iterable" href="https://docs.python.org/3/library/typing.html#typing.Iterable">Iterable</a></span><span class="p">[</span><span class="s1">&#39;BsseEnum&#39;</span><span class="p">],</span> <span class="n">nfragments</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n">nbodies</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Iterable" href="https://docs.python.org/3/library/typing.html#typing.Iterable">Iterable</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Literal" href="https://docs.python.org/3/library/typing.html#typing.Literal">Literal</a></span><span class="p">[</span><span class="s1">&#39;supersystem&#39;</span><span class="p">]]],</span> <span class="n">return_total_data</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span><span class="p">,</span> <span class="n">supersystem_ie_only</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></span><span class="p">,</span> <span class="n">supersystem_max_nbody</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Dict" href="https://docs.python.org/3/library/typing.html#typing.Dict">Dict</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-external" title="typing.Set" href="https://docs.python.org/3/library/typing.html#typing.Set">Set</a></span><span class="p">[</span><span class="s1">&#39;FragBasIndex&#39;</span><span class="p">]]]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Generates lists of N-Body computations needed for requested BSSE treatments.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>bsse_type</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Iterable" href="https://docs.python.org/3/library/typing.html#typing.Iterable">Iterable</a>[&#39;BsseEnum&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Requested BSSE treatments.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nfragments</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of distinct fragments comprising the full molecular supersystem.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nbodies</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Iterable" href="https://docs.python.org/3/library/typing.html#typing.Iterable">Iterable</a>[<a class="autorefs autorefs-external" title="typing.Union" href="https://docs.python.org/3/library/typing.html#typing.Union">Union</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>, <a class="autorefs autorefs-external" title="typing.Literal" href="https://docs.python.org/3/library/typing.html#typing.Literal">Literal</a>[&#39;supersystem&#39;]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of n-body levels (e.g., <code>[2]</code> or <code>[1, 2]</code> or <code>["supersystem"]</code>) for which to generate tasks.
Note the natural 1-indexing, so <code>[1]</code> covers one-body contributions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_total_data</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the total data (True; energy/gradient/Hessian) of the molecular system has been requested,
as opposed to interaction data (False).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>supersystem_ie_only</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#bool">bool</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target the supersystem total/interaction energy (IE) data over the many-body expansion (MBE) "
analysis, thereby omitting intermediate-body calculations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>supersystem_max_nbody</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/3/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum n-body to use for a supersystem calculation. Must be specified if "supersystem" is in <code>nbodies</code></p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="compute_dict">compute_dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing subdicts enumerating compute lists for each possible BSSE treatment.
Subdict keys are n-body levels and values are sets of all the <code>mc_(frag, bas)</code> indices
needed to compute that n-body level. A given index can appear multiple times within a
subdict and among subdicts.</p>
<pre><code>compute_dict["cp"] = {
    1: set(),
    2: {((1,), (1, 2)),
        ((2,), (1, 2)),
        ((1, 2), (1, 2))}
}
</code></pre>
<p>Subdicts below are always returned. Any may be empty if not requested through <em>bsse_type</em>.</p>
<ul>
<li><code>'all'</code> |w---w| full list of computations required</li>
<li><code>'cp'</code> |w---w| list of computations required for CP procedure</li>
<li><code>'nocp'</code> |w---w| list of computations required for non-CP procedure</li>
<li><code>'vmfc_compute'</code> |w---w| list of computations required for VMFC procedure</li>
<li><code>'vmfc_levels'</code> |w---w| list of levels required for VMFC procedure</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>qcmanybody/builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_nbody_compute_list</span><span class="p">(</span>
    <span class="n">bsse_type</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;BsseEnum&quot;</span><span class="p">],</span>
    <span class="n">nfragments</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">nbodies</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;supersystem&quot;</span><span class="p">]]],</span>
    <span class="n">return_total_data</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">supersystem_ie_only</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">supersystem_max_nbody</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="s2">&quot;FragBasIndex&quot;</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates lists of N-Body computations needed for requested BSSE treatments.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bsse_type</span>
<span class="sd">        Requested BSSE treatments.</span>
<span class="sd">    nfragments</span>
<span class="sd">        Number of distinct fragments comprising the full molecular supersystem.</span>
<span class="sd">    nbodies</span>
<span class="sd">        List of n-body levels (e.g., `[2]` or `[1, 2]` or `[&quot;supersystem&quot;]`) for which to generate tasks.</span>
<span class="sd">        Note the natural 1-indexing, so `[1]` covers one-body contributions.</span>
<span class="sd">    return_total_data</span>
<span class="sd">        Whether the total data (True; energy/gradient/Hessian) of the molecular system has been requested,</span>
<span class="sd">        as opposed to interaction data (False).</span>
<span class="sd">    supersystem_ie_only</span>
<span class="sd">        Target the supersystem total/interaction energy (IE) data over the many-body expansion (MBE) &quot;</span>
<span class="sd">        analysis, thereby omitting intermediate-body calculations.</span>
<span class="sd">    supersystem_max_nbody</span>
<span class="sd">        Maximum n-body to use for a supersystem calculation. Must be specified if &quot;supersystem&quot; is in `nbodies`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    compute_dict</span>
<span class="sd">        Dictionary containing subdicts enumerating compute lists for each possible BSSE treatment.</span>
<span class="sd">        Subdict keys are n-body levels and values are sets of all the `mc_(frag, bas)` indices</span>
<span class="sd">        needed to compute that n-body level. A given index can appear multiple times within a</span>
<span class="sd">        subdict and among subdicts.</span>

<span class="sd">            compute_dict[&quot;cp&quot;] = {</span>
<span class="sd">                1: set(),</span>
<span class="sd">                2: {((1,), (1, 2)),</span>
<span class="sd">                    ((2,), (1, 2)),</span>
<span class="sd">                    ((1, 2), (1, 2))}</span>
<span class="sd">            }</span>

<span class="sd">        Subdicts below are always returned. Any may be empty if not requested through *bsse_type*.</span>

<span class="sd">        * ``&#39;all&#39;`` |w---w| full list of computations required</span>
<span class="sd">        * ``&#39;cp&#39;`` |w---w| list of computations required for CP procedure</span>
<span class="sd">        * ``&#39;nocp&#39;`` |w---w| list of computations required for non-CP procedure</span>
<span class="sd">        * ``&#39;vmfc_compute&#39;`` |w---w| list of computations required for VMFC procedure</span>
<span class="sd">        * ``&#39;vmfc_levels&#39;`` |w---w| list of levels required for VMFC procedure</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">include_supersystem</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s2">&quot;supersystem&quot;</span> <span class="ow">in</span> <span class="n">nbodies</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">supersystem_max_nbody</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;supersystem_max_nbody must be provided if &#39;supersystem&#39; contains nbodies&quot;</span><span class="p">)</span>

        <span class="n">include_supersystem</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">nbodies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nbodies</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;supersystem&quot;</span><span class="p">]</span>

    <span class="c1"># What levels do we need?</span>
    <span class="n">fragment_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nfragments</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Need nbodies and all lower-body in full basis</span>
    <span class="n">cp_compute_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nbodies</span><span class="p">}</span>
    <span class="n">nocp_compute_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nbodies</span><span class="p">}</span>
    <span class="n">vmfc_compute_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nbodies</span><span class="p">}</span>
    <span class="n">vmfc_level_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nbodies</span><span class="p">}</span>  <span class="c1"># Need to sum something slightly different</span>

    <span class="c1"># Verify proper passing of bsse_type. already validated in Computer</span>
    <span class="n">bsse_type_remainder</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">bsse_type</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="n">e</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">BsseEnum</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">bsse_type_remainder</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized BSSE type(s): </span><span class="si">{</span><span class="n">bsse_type_remainder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Build up compute sets</span>
    <span class="k">if</span> <span class="s2">&quot;cp&quot;</span> <span class="ow">in</span> <span class="n">bsse_type</span><span class="p">:</span>
        <span class="c1"># Everything is in counterpoise/nfr-mer basis</span>
        <span class="n">basis_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fragment_range</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">supersystem_ie_only</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sublevel</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">nfragments</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">fragment_range</span><span class="p">,</span> <span class="n">sublevel</span><span class="p">):</span>
                    <span class="n">cp_compute_list</span><span class="p">[</span><span class="n">nfragments</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">basis_tuple</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">nbodies</span><span class="p">:</span>
                <span class="c1"># Note A.1: nb=1 is skipped because the nfr-mer-basis monomer</span>
                <span class="c1">#   contributions cancel at 1-body. These skipped tasks will be</span>
                <span class="c1">#   ordered anyways if higher bodies are requested. Monomers for</span>
                <span class="c1">#   the purpose of total energies use monomer basis, not these</span>
                <span class="c1">#   skipped tasks. See coordinating Note A.2 .</span>
                <span class="k">if</span> <span class="n">nb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sublevel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">fragment_range</span><span class="p">,</span> <span class="n">sublevel</span><span class="p">):</span>
                            <span class="n">cp_compute_list</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">basis_tuple</span><span class="p">))</span>

    <span class="k">if</span> <span class="s2">&quot;nocp&quot;</span> <span class="ow">in</span> <span class="n">bsse_type</span><span class="p">:</span>
        <span class="c1"># Everything in natural/n-mer basis</span>
        <span class="k">if</span> <span class="n">supersystem_ie_only</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sublevel</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">nfragments</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">fragment_range</span><span class="p">,</span> <span class="n">sublevel</span><span class="p">):</span>
                    <span class="n">nocp_compute_list</span><span class="p">[</span><span class="n">nfragments</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">nbodies</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sublevel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">fragment_range</span><span class="p">,</span> <span class="n">sublevel</span><span class="p">):</span>
                        <span class="n">nocp_compute_list</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>

    <span class="k">if</span> <span class="s2">&quot;vmfc&quot;</span> <span class="ow">in</span> <span class="n">bsse_type</span><span class="p">:</span>
        <span class="c1"># Like a CP for all combinations of pairs or greater</span>
        <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">nbodies</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cp_combos</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">fragment_range</span><span class="p">,</span> <span class="n">nb</span><span class="p">):</span>
                <span class="n">basis_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">cp_combos</span><span class="p">)</span>
                <span class="c1"># TODO vmfc_compute_list and vmfc_level_list are identical, so consolidate</span>
                <span class="k">for</span> <span class="n">interior_nbody</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">cp_combos</span><span class="p">,</span> <span class="n">interior_nbody</span><span class="p">):</span>
                        <span class="n">combo_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">basis_tuple</span><span class="p">)</span>
                        <span class="n">vmfc_compute_list</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">combo_tuple</span><span class="p">)</span>
                        <span class="n">vmfc_level_list</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">basis_tuple</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">combo_tuple</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_total_data</span> <span class="ow">and</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">nbodies</span><span class="p">:</span>
        <span class="c1"># Monomers in monomer basis</span>
        <span class="n">nocp_compute_list</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">ifr</span> <span class="ow">in</span> <span class="n">fragment_range</span><span class="p">:</span>
            <span class="n">nocp_compute_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(((</span><span class="n">ifr</span><span class="p">,),</span> <span class="p">(</span><span class="n">ifr</span><span class="p">,)))</span>

    <span class="k">if</span> <span class="n">include_supersystem</span><span class="p">:</span>
        <span class="c1"># Add supersystem info to the compute list (nocp only)</span>
        <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">supersystem_max_nbody</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">cp_compute_list</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
            <span class="n">nocp_compute_list</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
            <span class="n">vmfc_compute_list</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">sublevel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">fragment_range</span><span class="p">,</span> <span class="n">sublevel</span><span class="p">):</span>
                    <span class="n">nocp_compute_list</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>

        <span class="c1"># Add the total supersystem (nfragments@nfragments)</span>
        <span class="n">nocp_compute_list</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">nfragments</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
        <span class="n">nocp_compute_list</span><span class="p">[</span><span class="n">nfragments</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="nb">tuple</span><span class="p">(</span><span class="n">fragment_range</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fragment_range</span><span class="p">)))</span>

    <span class="c1"># Build a comprehensive compute range</span>
    <span class="c1"># * do not use list length to count number of {nb}-body computations</span>
    <span class="n">compute_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nbodies</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">nbodies</span><span class="p">:</span>
        <span class="n">compute_list</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cp_compute_list</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span>
        <span class="n">compute_list</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nocp_compute_list</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span>
        <span class="n">compute_list</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">|=</span> <span class="n">vmfc_compute_list</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">include_supersystem</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">nb</span><span class="p">,</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">nocp_compute_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">compute_list</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
            <span class="n">compute_list</span><span class="p">[</span><span class="n">nb</span><span class="p">]</span> <span class="o">|=</span> <span class="n">lst</span>

    <span class="n">compute_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="n">compute_list</span><span class="p">,</span>
        <span class="s2">&quot;cp&quot;</span><span class="p">:</span> <span class="n">cp_compute_list</span><span class="p">,</span>
        <span class="s2">&quot;nocp&quot;</span><span class="p">:</span> <span class="n">nocp_compute_list</span><span class="p">,</span>
        <span class="s2">&quot;vmfc_compute&quot;</span><span class="p">:</span> <span class="n">vmfc_compute_list</span><span class="p">,</span>
        <span class="s2">&quot;vmfc_levels&quot;</span><span class="p">:</span> <span class="n">vmfc_level_list</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">compute_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024-2025 QCManyBody Developers
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>